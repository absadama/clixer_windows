---
description: Clixer security implementations - 2FA, authentication, session management
alwaysApply: true
---

# Clixer Security Implementations (26 Ocak 2026 - Güncelleme 3)

## 2FA (Two-Factor Authentication) Sistemi

### Sistem Geneli 2FA Zorunluluğu
- Admin Panel → Sistem Ayarları → Güvenlik → "2FA Zorunlu" ayarı
- `system_settings` tablosunda `key = '2fa_enabled'` veya `key = 'require_2fa'`
- Value formatı: `{"type": "boolean", "value": "true", ...}` (JSONB)

### PostgreSQL JSONB Parsing Dikkat!
PostgreSQL driver JSONB kolonları otomatik parse eder. `JSON.parse()` çağırma!

```typescript
// YANLIŞ - Hata verir çünkü value zaten object
const parsed = JSON.parse(twoFactorSetting.value);

// DOĞRU - Önce tip kontrolü yap
if (typeof val === 'object' && val !== null) {
  systemRequires2FA = val.value === 'true' || val.value === true;
} else if (typeof val === 'string') {
  const parsed = JSON.parse(val);
  systemRequires2FA = parsed?.value === 'true';
}
```

### 2FA Setup Akışı
1. Kullanıcı login olur (email + şifre)
2. Sistem 2FA zorunlu ama kullanıcı kurulum yapmamışsa → `requires2FASetup: true` + `setupToken` döner
3. Frontend QR kod ekranı gösterir
4. Kullanıcı Google Authenticator ile tarar
5. 6 haneli kod girer, doğrulanır
6. Backup kodları gösterilir
7. Login tamamlanır

### Remember Device (Cihazı Hatırla)
- 30 gün TTL ile Redis'te trusted device token saklanır
- Key: `trusted_device:${userId}:${deviceToken}`
- 2FA doğrulandıktan sonra "Bu cihazı hatırla" seçilirse oluşturulur
- Sonraki loginlerde 2FA bypass edilir

## Session Security

### Redis Token Blacklist
Kullanıcı deaktif edildiğinde veya silindiğinde token'ı blacklist'e al:
```typescript
await cache.set(`blacklist:${userId}`, 'true', 86400);
```

Her authenticated request'te kontrol:
```typescript
const isBlacklisted = await isUserBlacklisted(userId);
if (isBlacklisted) throw new AuthenticationError('Session revoked');
```

### Phone Number Security Layer
- `users` tablosunda `phone_number` ve `phone_active` kolonları
- `phone_active = false` → Kullanıcı login olamaz
- Admin Panel'den yönetilir (whitelist mantığı)

## Güvenlik Düzeltmeleri (Pentest Sonrası)

### 1. Purpose Token Koruması
2FA setup token'ları genel endpoint'lerde kullanılamaz:
```typescript
// shared/src/auth.ts - authenticate middleware
if ((user as any).purpose) {
  throw new AuthenticationError('Bu token genel erişim için kullanılamaz');
}
```

### 2. 2FA Setup Token Tek Kullanım
```typescript
// auth-service - /2fa/setup endpoint
const tokenUsedKey = `2fa_setup_used:${userId}`;
const alreadyUsed = await cache.get(tokenUsedKey);
if (alreadyUsed) {
  throw new AuthenticationError('Bu kurulum token\'ı zaten kullanıldı');
}
// Kullanıldıktan sonra işaretle
await cache.set(tokenUsedKey, 'true', 3600);
```

### 3. LDAP Fallback Kaldırıldı
LDAP kullanıcısı SADECE LDAP ile giriş yapabilir. Database password fallback **backdoor** oluşturuyordu.
```typescript
// ESKİ (GÜVENSİZ) - Kaldırıldı
if (!isValid) {
  isValid = await verifyPassword(password, user.password_hash);
}
```

### 4. Trusted Device IP/UA Binding
Trusted device token çalınsa bile farklı IP/UA'dan kullanılamaz:
```typescript
const ipHash = crypto.createHash('md5').update(currentIp).digest('hex');
const uaHash = crypto.createHash('md5').update(userAgent).digest('hex');
await cache.set(trustedKey, JSON.stringify({ ipHash, uaHash }), TTL);
```

### 5. Data Connection Password Encryption
```typescript
// data-service - INSERT/UPDATE
const { encrypt } = require('@clixer/shared');
const encryptedPassword = password ? encrypt(password) : null;
```

### 6. Position Permissions - SUPER_ADMIN Only
Pozisyon izinleri tüm tenant'ları etkiler, sadece SUPER_ADMIN değiştirebilir:
```typescript
router.put('/:code/permissions', authenticate, authorize(ROLES.SUPER_ADMIN), ...)
```

### 7. Analytics Endpoints - Authorization
ClickHouse raw query sadece SUPER_ADMIN:
```typescript
app.post('/clickhouse/query', authenticate, authorize(ROLES.SUPER_ADMIN), ...)
app.get('/clickhouse/tables', authenticate, authorize(ROLES.ADMIN, ROLES.SUPER_ADMIN), ...)
```

### 8. Gateway IP Spoofing Fix
```typescript
// ESKİ (GÜVENSİZ)
const forwarded = req.headers['x-forwarded-for']; // Spoofable!

// YENİ (GÜVENLİ)
return req.ip || req.socket.remoteAddress || ''; // Trust proxy ayarına güvenir
```

### 9. Redis Fail-Closed (Production)
```typescript
if (process.env.NODE_ENV === 'production') {
  throw new AuthenticationError('Kimlik doğrulama servisi geçici olarak kullanılamıyor');
}
```

### 10. SSRF DNS Rebinding Koruması
```typescript
// safeFetch içinde DNS çözümlemesi doğrulaması
const dnsValidation = await resolveAndValidateHost(hostname);
if (!dnsValidation.valid) {
  throw new Error(`SSRF koruması (DNS): ${dnsValidation.error}`);
}
```

## Kritik Dosyalar

| Dosya | Sorumluluk |
|-------|------------|
| `auth-service/src/index.ts` | Login, 2FA, token generation |
| `frontend/src/stores/authStore.ts` | Auth state, 2FA setup state |
| `frontend/src/pages/LoginPage.tsx` | 2FA setup UI, QR kod ekranı |
| `shared/src/auth.ts` | Token validation, blacklist check, purpose token |
| `shared/src/security.ts` | Encryption, SSRF protection, sanitization |
| `gateway/src/index.ts` | Rate limiting, IP whitelist, proxy |
| `data-service/src/index.ts` | Connection management, password encryption |
| `core-service/routes/positions.routes.ts` | Position permissions (SUPER_ADMIN) |

## Kabul Edilen Riskler

| Risk | Neden Kabul Edilebilir |
|------|------------------------|
| ETL custom_where SQL | Admin yetkisi gerektirir |
| ETL source_query | Admin yetkisi gerektirir |
| Timing attack | Pratik istismarı imkansıza yakın |

## Test Komutları

```powershell
# Login test (2FA setup kontrolü)
$body = '{"email":"admin@clixer","password":"Admin123!"}'
Invoke-WebRequest -Uri "http://localhost:4001/login" -Method POST -ContentType "application/json" -Body $body

# Beklenen response (2FA zorunlu ama kurulu değilse):
# {"success":false,"requires2FASetup":true,"setupToken":"..."}
```

---

# Report Subscription & Screenshot Sistemi (26 Ocak 2026)

## Kritik Öğrenimler

### 1. Puppeteer IPv4 Zorunluluğu (Windows)
Windows'ta Puppeteer `localhost` yerine `127.0.0.1` kullanmalı:
```typescript
// YANLIŞ - Windows'ta IPv6'ya çözümlenir, bağlantı başarısız
const frontendUrl = 'http://localhost:3000';

// DOĞRU - Explicit IPv4
const frontendUrl = 'http://127.0.0.1:3000';
```

Vite config'de de host ayarı:
```typescript
// vite.config.ts
server: {
  host: '127.0.0.1',
  port: 3000
}
```

### 2. Screenshot Modunda Zustand Store Sorunu
Puppeteer headless modunda Zustand store düzgün hydrate olmaz. **Local state kullan!**

```typescript
// YANLIŞ - Zustand store hydrate olmayabilir
const { widgets } = useDashboardStore();

// DOĞRU - Screenshot modunda local state kullan
const [localWidgets, setLocalWidgets] = useState<any[]>([]);
const isScreenshotMode = searchParams.get('screenshot') === 'true';

// Screenshot modunda API'den direkt local state'e yükle
if (isScreenshotMode) {
  const response = await fetch(`/api/designs/${designId}`);
  const data = await response.json();
  setLocalWidgets(data.widgets); // Zustand değil, local state
}

// Render'da conditional kullan
const sortedWidgets = useMemo(() => {
  const source = isScreenshotMode ? localWidgets : storeWidgets;
  return source.sort(...);
}, [isScreenshotMode, localWidgets, storeWidgets]);
```

### 3. Sidebar Gizleme için Data Attribute
CSS selector ile sidebar bulunamaz, explicit attribute ekle:

```tsx
// Layout.tsx - Sidebar container'a attribute ekle
<div 
  data-sidebar="desktop"
  className="hidden lg:flex lg:fixed..."
>
  <SidebarContent />
</div>
```

```typescript
// screenshot.service.ts - Doğru selector
const sidebar = document.querySelector('[data-sidebar="desktop"]');
if (sidebar) sidebar.style.display = 'none';

// Main content padding'i kaldır
const wrapper = document.querySelector('[data-testid="dashboard-content"]')
  ?.closest('div[class*="lg:pl-"]');
if (wrapper) wrapper.style.paddingLeft = '0';
```

### 4. CSS Grid Headless Modda Expand Olmaz
Grid container'a explicit height ve row template ver:

```typescript
const gridContainer = document.querySelector('[data-testid="dashboard-content"] > div:nth-child(2)');
if (gridContainer) {
  gridContainer.style.overflow = 'visible';
  gridContainer.style.height = 'auto';
  gridContainer.style.gridTemplateRows = 'repeat(50, 40px)'; // Force rows
}
```

### 5. Widget Stabilization Polling
Widget'ların yüklenmesini beklemek için count polling:

```typescript
let lastCount = 0, stableCount = 0;
while (stableCount < 3) {
  const currentCount = await page.evaluate(() => 
    document.querySelectorAll('[data-widget]').length
  );
  if (currentCount === lastCount && currentCount > 0) {
    stableCount++;
  } else {
    stableCount = 0;
    lastCount = currentCount;
  }
  await page.waitForTimeout(1000);
}
```

### 6. Service Token - Purpose Field OLMAMALI
Screenshot service token'ında `purpose` field olmamalı, yoksa authenticate middleware reject eder:

```typescript
// DOĞRU - purpose yok
jwt.sign({
  userId: 'screenshot-service',
  tenantId,
  role: 'ADMIN',
  iat: Math.floor(Date.now() / 1000)
}, secret, { expiresIn: '5m' });
```

### 7. localStorage Auth State Yapısı
Puppeteer'da localStorage'a Zustand-compatible format:

```typescript
const authState = {
  state: {
    user: { id, email, name, role, tenantId, ... },
    accessToken: token,
    isAuthenticated: true,
    hasHydrated: true,  // KRİTİK!
    // ...diğer alanlar
  },
  version: 0
};
localStorage.setItem('clixer-auth', JSON.stringify(authState));
```

## Kritik Dosyalar - Screenshot

| Dosya | Sorumluluk |
|-------|------------|
| `notification-service/src/services/screenshot.service.ts` | Puppeteer screenshot capture |
| `notification-service/src/services/scheduler.service.ts` | Cron jobs, subscription processing |
| `notification-service/src/services/email.service.ts` | Email gönderimi |
| `frontend/src/pages/DashboardPage.tsx` | Cockpit screenshot render |
| `frontend/src/pages/AnalysisPage.tsx` | Analysis screenshot render |
| `frontend/src/components/Layout.tsx` | Sidebar data-attribute |

## Manuel Test

```powershell
# Subscription tetikle
echo '{"subscriptionId":"<UUID>","tenantId":"<TENANT>","manual":true}' | docker exec -i clixer_redis redis-cli -x PUBLISH subscription:send
```

---

# Production Deployment Checklist (26 Ocak 2026 - Tavukdunyası)

## PM2 Environment Variables Sorunu

PM2 `.env` dosyasını otomatik yüklemez! `ecosystem.config.js` düzenlenmeli:

```javascript
// ecosystem.config.js - EN BAŞA EKLE
require('dotenv').config();

const commonEnv = {
  NODE_ENV: 'production',
  JWT_SECRET: process.env.JWT_SECRET,
  ENCRYPTION_KEY: process.env.ENCRYPTION_KEY,
  DATABASE_URL: process.env.DATABASE_URL,
  REDIS_URL: process.env.REDIS_URL,
  CLICKHOUSE_URL: process.env.CLICKHOUSE_URL
};

module.exports = {
  apps: [
    {
      name: 'notification',
      script: './services/notification-service/dist/index.js',
      env: {
        ...commonEnv,
        PORT: 4004
      }
    },
    // ... diğer servisler de commonEnv kullanmalı
  ]
};
```

## Notification Service Database Tabloları

Sunucuda bu tablolar MUTLAKA olmalı. Yoksa 500 hatası alırsın:

```sql
-- Docker ile çalıştır:
-- docker exec -i clixer_postgres psql -U clixer -d clixer << 'EOF'

-- Email Settings tablosu
CREATE TABLE IF NOT EXISTS email_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    smtp_host VARCHAR(255),
    smtp_port INTEGER DEFAULT 587,
    smtp_secure BOOLEAN DEFAULT false,
    smtp_user VARCHAR(255),
    smtp_password_encrypted TEXT,
    from_email VARCHAR(255),
    from_name VARCHAR(255),
    is_configured BOOLEAN DEFAULT false,
    last_test_at TIMESTAMP,
    last_test_result TEXT,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(tenant_id)
);

-- Report Subscriptions tablosu
CREATE TABLE IF NOT EXISTS report_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    design_id UUID NOT NULL,
    design_type VARCHAR(50) NOT NULL CHECK (design_type IN ('cockpit', 'analysis')),
    recipient_user_ids UUID[] NOT NULL DEFAULT '{}',
    recipient_emails TEXT[],
    schedule_cron VARCHAR(100) NOT NULL,
    schedule_description VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    last_sent_at TIMESTAMP,
    last_error TEXT,
    send_count INTEGER DEFAULT 0,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Subscription Logs tablosu
CREATE TABLE IF NOT EXISTS subscription_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    subscription_id UUID NOT NULL REFERENCES report_subscriptions(id) ON DELETE CASCADE,
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    status VARCHAR(50) NOT NULL,
    action VARCHAR(50),
    recipients_count INTEGER,
    error_message TEXT,
    sent_at TIMESTAMP DEFAULT NOW()
);

-- Indexler
CREATE INDEX IF NOT EXISTS idx_email_settings_tenant ON email_settings(tenant_id);
CREATE INDEX IF NOT EXISTS idx_report_subscriptions_tenant ON report_subscriptions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_report_subscriptions_active ON report_subscriptions(is_active) WHERE is_active = true;
CREATE INDEX IF NOT EXISTS idx_subscription_logs_subscription ON subscription_logs(subscription_id);
```

## Users Tablosu - token_version Kolonu

Şifre değiştirme için gerekli:

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS token_version INTEGER DEFAULT 0;
```

## Puppeteer Chromium Kurulumu (Ubuntu)

```bash
# Sistem Chromium yükle
sudo apt update && sudo apt install -y chromium-browser

# Puppeteer Chromium indirmesini atla
cd /opt/clixer/services/notification-service
sudo PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm install
```

## Gateway Port Binding Sorunu (EADDRINUSE)

PM2 cluster mode'da port sorunu olursa:

```bash
# Gateway'i tamamen durdur ve sil
sudo pm2 stop gateway
sudo pm2 delete gateway

# Port'u kullanan süreçleri öldür
sudo kill -9 $(sudo lsof -t -i :4000)

# Gateway'i yeniden derle
cd /opt/clixer/gateway
sudo npm run build

# Yeniden başlat
cd /opt/clixer
sudo pm2 start ecosystem.config.js --only gateway
```

## Deployment Sırası

1. **Git Pull**
   ```bash
   cd /opt/clixer
   sudo git pull origin master
   ```

2. **Shared Module Build** (diğerleri buna bağımlı)
   ```bash
   cd /opt/clixer/shared
   sudo npm install
   sudo npm run build
   ```

3. **Her Servis İçin**
   ```bash
   cd /opt/clixer/services/<service-name>
   sudo npm install
   sudo npm run build
   ```

4. **Gateway Build**
   ```bash
   cd /opt/clixer/gateway
   sudo npm install
   sudo npm run build
   ```

5. **Frontend Build** (production için)
   ```bash
   cd /opt/clixer/frontend
   sudo npm install
   sudo npm run build
   ```

6. **PM2 Restart**
   ```bash
   cd /opt/clixer
   sudo pm2 restart all
   # veya
   sudo pm2 start ecosystem.config.js
   ```

7. **Database Migrations** (varsa)
   ```bash
   docker exec -i clixer_postgres psql -U clixer -d clixer < migrations.sql
   ```

## Log Kontrol Komutları

```bash
# Tüm servisler
sudo pm2 status

# Belirli servis logları
sudo pm2 logs notification --lines 50
sudo pm2 logs gateway --lines 50

# Hata logları
sudo pm2 logs --err --lines 100
```

## Hızlı Sorun Giderme

| Hata | Çözüm |
|------|-------|
| `JWT_SECRET environment variable is required` | ecosystem.config.js'e commonEnv ekle |
| `relation "xxx" does not exist` | Yukarıdaki SQL'leri çalıştır |
| `column "xxx" does not exist` | ALTER TABLE ile kolon ekle |
| `EADDRINUSE :4000` | Gateway port temizle ve restart |
| `404 on /api/notification/*` | Gateway rebuild + restart |
| `502 Bad Gateway` | İlgili servis çalışmıyor, pm2 logs kontrol |

## Docker Container İsimleri (Tavukdunyası)

```bash
# PostgreSQL
docker exec -i clixer_postgres psql -U clixer -d clixer

# Redis
docker exec -i clixer_redis redis-cli

# ClickHouse
docker exec -i clixer_clickhouse clickhouse-client
```
