---
description: Clixer security implementations - 2FA, authentication, session management
alwaysApply: true
---

# Clixer Security Implementations (26 Ocak 2026 - GÃ¼ncelleme 3)

## 2FA (Two-Factor Authentication) Sistemi

### Sistem Geneli 2FA ZorunluluÄŸu
- Admin Panel â†’ Sistem AyarlarÄ± â†’ GÃ¼venlik â†’ "2FA Zorunlu" ayarÄ±
- `system_settings` tablosunda `key = '2fa_enabled'` veya `key = 'require_2fa'`
- Value formatÄ±: `{"type": "boolean", "value": "true", ...}` (JSONB)

### PostgreSQL JSONB Parsing Dikkat!
PostgreSQL driver JSONB kolonlarÄ± otomatik parse eder. `JSON.parse()` Ã§aÄŸÄ±rma!

```typescript
// YANLIÅž - Hata verir Ã§Ã¼nkÃ¼ value zaten object
const parsed = JSON.parse(twoFactorSetting.value);

// DOÄžRU - Ã–nce tip kontrolÃ¼ yap
if (typeof val === 'object' && val !== null) {
  systemRequires2FA = val.value === 'true' || val.value === true;
} else if (typeof val === 'string') {
  const parsed = JSON.parse(val);
  systemRequires2FA = parsed?.value === 'true';
}
```

### 2FA Setup AkÄ±ÅŸÄ±
1. KullanÄ±cÄ± login olur (email + ÅŸifre)
2. Sistem 2FA zorunlu ama kullanÄ±cÄ± kurulum yapmamÄ±ÅŸsa â†’ `requires2FASetup: true` + `setupToken` dÃ¶ner
3. Frontend QR kod ekranÄ± gÃ¶sterir
4. KullanÄ±cÄ± Google Authenticator ile tarar
5. 6 haneli kod girer, doÄŸrulanÄ±r
6. Backup kodlarÄ± gÃ¶sterilir
7. Login tamamlanÄ±r

### Remember Device (CihazÄ± HatÄ±rla)
- 30 gÃ¼n TTL ile Redis'te trusted device token saklanÄ±r
- Key: `trusted_device:${userId}:${deviceToken}`
- 2FA doÄŸrulandÄ±ktan sonra "Bu cihazÄ± hatÄ±rla" seÃ§ilirse oluÅŸturulur
- Sonraki loginlerde 2FA bypass edilir

## Session Security

### Redis Token Blacklist
KullanÄ±cÄ± deaktif edildiÄŸinde veya silindiÄŸinde token'Ä± blacklist'e al:
```typescript
await cache.set(`blacklist:${userId}`, 'true', 86400);
```

Her authenticated request'te kontrol:
```typescript
const isBlacklisted = await isUserBlacklisted(userId);
if (isBlacklisted) throw new AuthenticationError('Session revoked');
```

### Phone Number Security Layer
- `users` tablosunda `phone_number` ve `phone_active` kolonlarÄ±
- `phone_active = false` â†’ KullanÄ±cÄ± login olamaz
- Admin Panel'den yÃ¶netilir (whitelist mantÄ±ÄŸÄ±)

## GÃ¼venlik DÃ¼zeltmeleri (Pentest SonrasÄ±)

### 1. Purpose Token KorumasÄ±
2FA setup token'larÄ± genel endpoint'lerde kullanÄ±lamaz:
```typescript
// shared/src/auth.ts - authenticate middleware
if ((user as any).purpose) {
  throw new AuthenticationError('Bu token genel eriÅŸim iÃ§in kullanÄ±lamaz');
}
```

### 2. 2FA Setup Token Tek KullanÄ±m
```typescript
// auth-service - /2fa/setup endpoint
const tokenUsedKey = `2fa_setup_used:${userId}`;
const alreadyUsed = await cache.get(tokenUsedKey);
if (alreadyUsed) {
  throw new AuthenticationError('Bu kurulum token\'Ä± zaten kullanÄ±ldÄ±');
}
// KullanÄ±ldÄ±ktan sonra iÅŸaretle
await cache.set(tokenUsedKey, 'true', 3600);
```

### 3. LDAP Fallback KaldÄ±rÄ±ldÄ±
LDAP kullanÄ±cÄ±sÄ± SADECE LDAP ile giriÅŸ yapabilir. Database password fallback **backdoor** oluÅŸturuyordu.
```typescript
// ESKÄ° (GÃœVENSÄ°Z) - KaldÄ±rÄ±ldÄ±
if (!isValid) {
  isValid = await verifyPassword(password, user.password_hash);
}
```

### 4. Trusted Device IP/UA Binding
Trusted device token Ã§alÄ±nsa bile farklÄ± IP/UA'dan kullanÄ±lamaz:
```typescript
const ipHash = crypto.createHash('md5').update(currentIp).digest('hex');
const uaHash = crypto.createHash('md5').update(userAgent).digest('hex');
await cache.set(trustedKey, JSON.stringify({ ipHash, uaHash }), TTL);
```

### 5. Data Connection Password Encryption
```typescript
// data-service - INSERT/UPDATE
const { encrypt } = require('@clixer/shared');
const encryptedPassword = password ? encrypt(password) : null;
```

### 6. Position Permissions - SUPER_ADMIN Only
Pozisyon izinleri tÃ¼m tenant'larÄ± etkiler, sadece SUPER_ADMIN deÄŸiÅŸtirebilir:
```typescript
router.put('/:code/permissions', authenticate, authorize(ROLES.SUPER_ADMIN), ...)
```

### 7. Analytics Endpoints - Authorization
ClickHouse raw query ADMIN ve SUPER_ADMIN (metrik Ã¶nizleme iÃ§in gerekli):
```typescript
app.post('/clickhouse/query', authenticate, authorize(ROLES.ADMIN, ROLES.SUPER_ADMIN), ...)
app.get('/clickhouse/tables', authenticate, authorize(ROLES.ADMIN, ROLES.SUPER_ADMIN), ...)
```

### 8. Gateway IP Spoofing Fix
```typescript
// ESKÄ° (GÃœVENSÄ°Z)
const forwarded = req.headers['x-forwarded-for']; // Spoofable!

// YENÄ° (GÃœVENLÄ°)
return req.ip || req.socket.remoteAddress || ''; // Trust proxy ayarÄ±na gÃ¼venir
```

### 9. Redis Fail-Closed (Production)
```typescript
if (process.env.NODE_ENV === 'production') {
  throw new AuthenticationError('Kimlik doÄŸrulama servisi geÃ§ici olarak kullanÄ±lamÄ±yor');
}
```

### 10. SSRF DNS Rebinding KorumasÄ±
```typescript
// safeFetch iÃ§inde DNS Ã§Ã¶zÃ¼mlemesi doÄŸrulamasÄ±
const dnsValidation = await resolveAndValidateHost(hostname);
if (!dnsValidation.valid) {
  throw new Error(`SSRF korumasÄ± (DNS): ${dnsValidation.error}`);
}
```

## Kritik Dosyalar

| Dosya | Sorumluluk |
|-------|------------|
| `auth-service/src/index.ts` | Login, 2FA, token generation |
| `frontend/src/stores/authStore.ts` | Auth state, 2FA setup state |
| `frontend/src/pages/LoginPage.tsx` | 2FA setup UI, QR kod ekranÄ± |
| `shared/src/auth.ts` | Token validation, blacklist check, purpose token |
| `shared/src/security.ts` | Encryption, SSRF protection, sanitization |
| `gateway/src/index.ts` | Rate limiting, IP whitelist, proxy |
| `data-service/src/index.ts` | Connection management, password encryption |
| `core-service/routes/positions.routes.ts` | Position permissions (SUPER_ADMIN) |

## Kabul Edilen Riskler

| Risk | Neden Kabul Edilebilir |
|------|------------------------|
| ETL custom_where SQL | Admin yetkisi gerektirir |
| ETL source_query | Admin yetkisi gerektirir |
| Timing attack | Pratik istismarÄ± imkansÄ±za yakÄ±n |

## Test KomutlarÄ±

```powershell
# Login test (2FA setup kontrolÃ¼)
$body = '{"email":"admin@clixer","password":"Admin123!"}'
Invoke-WebRequest -Uri "http://localhost:4001/login" -Method POST -ContentType "application/json" -Body $body

# Beklenen response (2FA zorunlu ama kurulu deÄŸilse):
# {"success":false,"requires2FASetup":true,"setupToken":"..."}
```

---

# Report Subscription & Screenshot Sistemi (26 Ocak 2026)

## Kritik Ã–ÄŸrenimler

### 1. Puppeteer IPv4 ZorunluluÄŸu (Windows)
Windows'ta Puppeteer `localhost` yerine `127.0.0.1` kullanmalÄ±:
```typescript
// YANLIÅž - Windows'ta IPv6'ya Ã§Ã¶zÃ¼mlenir, baÄŸlantÄ± baÅŸarÄ±sÄ±z
const frontendUrl = 'http://localhost:3000';

// DOÄžRU - Explicit IPv4
const frontendUrl = 'http://127.0.0.1:3000';
```

Vite config'de de host ayarÄ±:
```typescript
// vite.config.ts
server: {
  host: '127.0.0.1',
  port: 3000
}
```

### 2. Screenshot Modunda Zustand Store Sorunu
Puppeteer headless modunda Zustand store dÃ¼zgÃ¼n hydrate olmaz. **Local state kullan!**

```typescript
// YANLIÅž - Zustand store hydrate olmayabilir
const { widgets } = useDashboardStore();

// DOÄžRU - Screenshot modunda local state kullan
const [localWidgets, setLocalWidgets] = useState<any[]>([]);
const isScreenshotMode = searchParams.get('screenshot') === 'true';

// Screenshot modunda API'den direkt local state'e yÃ¼kle
if (isScreenshotMode) {
  const response = await fetch(`/api/designs/${designId}`);
  const data = await response.json();
  setLocalWidgets(data.widgets); // Zustand deÄŸil, local state
}

// Render'da conditional kullan
const sortedWidgets = useMemo(() => {
  const source = isScreenshotMode ? localWidgets : storeWidgets;
  return source.sort(...);
}, [isScreenshotMode, localWidgets, storeWidgets]);
```

### 3. Sidebar Gizleme iÃ§in Data Attribute
CSS selector ile sidebar bulunamaz, explicit attribute ekle:

```tsx
// Layout.tsx - Sidebar container'a attribute ekle
<div 
  data-sidebar="desktop"
  className="hidden lg:flex lg:fixed..."
>
  <SidebarContent />
</div>
```

```typescript
// screenshot.service.ts - DoÄŸru selector
const sidebar = document.querySelector('[data-sidebar="desktop"]');
if (sidebar) sidebar.style.display = 'none';

// Main content padding'i kaldÄ±r
const wrapper = document.querySelector('[data-testid="dashboard-content"]')
  ?.closest('div[class*="lg:pl-"]');
if (wrapper) wrapper.style.paddingLeft = '0';
```

### 4. CSS Grid Headless Modda Expand Olmaz
Grid container'a explicit height ve row template ver:

```typescript
const gridContainer = document.querySelector('[data-testid="dashboard-content"] > div:nth-child(2)');
if (gridContainer) {
  gridContainer.style.overflow = 'visible';
  gridContainer.style.height = 'auto';
  gridContainer.style.gridTemplateRows = 'repeat(50, 40px)'; // Force rows
}
```

### 5. Widget Stabilization Polling
Widget'larÄ±n yÃ¼klenmesini beklemek iÃ§in count polling:

```typescript
let lastCount = 0, stableCount = 0;
while (stableCount < 3) {
  const currentCount = await page.evaluate(() => 
    document.querySelectorAll('[data-widget]').length
  );
  if (currentCount === lastCount && currentCount > 0) {
    stableCount++;
  } else {
    stableCount = 0;
    lastCount = currentCount;
  }
  await page.waitForTimeout(1000);
}
```

### 6. Service Token - Purpose Field OLMAMALI
Screenshot service token'Ä±nda `purpose` field olmamalÄ±, yoksa authenticate middleware reject eder:

```typescript
// DOÄžRU - purpose yok
jwt.sign({
  userId: 'screenshot-service',
  tenantId,
  role: 'ADMIN',
  iat: Math.floor(Date.now() / 1000)
}, secret, { expiresIn: '5m' });
```

### 7. localStorage Auth State YapÄ±sÄ±
Puppeteer'da localStorage'a Zustand-compatible format:

```typescript
const authState = {
  state: {
    user: { id, email, name, role, tenantId, ... },
    accessToken: token,
    isAuthenticated: true,
    hasHydrated: true,  // KRÄ°TÄ°K!
    // ...diÄŸer alanlar
  },
  version: 0
};
localStorage.setItem('clixer-auth', JSON.stringify(authState));
```

## Kritik Dosyalar - Screenshot

| Dosya | Sorumluluk |
|-------|------------|
| `notification-service/src/services/screenshot.service.ts` | Puppeteer screenshot capture |
| `notification-service/src/services/scheduler.service.ts` | Cron jobs, subscription processing |
| `notification-service/src/services/email.service.ts` | Email gÃ¶nderimi |
| `frontend/src/pages/DashboardPage.tsx` | Cockpit screenshot render |
| `frontend/src/pages/AnalysisPage.tsx` | Analysis screenshot render |
| `frontend/src/components/Layout.tsx` | Sidebar data-attribute |

## Manuel Test

```powershell
# Subscription tetikle
echo '{"subscriptionId":"<UUID>","tenantId":"<TENANT>","manual":true}' | docker exec -i clixer_redis redis-cli -x PUBLISH subscription:send
```

---

# Production Deployment Checklist (26 Ocak 2026 - TavukdunyasÄ±)

## PM2 Environment Variables Sorunu

PM2 `.env` dosyasÄ±nÄ± otomatik yÃ¼klemez! `ecosystem.config.js` dÃ¼zenlenmeli:

```javascript
// ecosystem.config.js - EN BAÅžA EKLE
require('dotenv').config();

const commonEnv = {
  NODE_ENV: 'production',
  JWT_SECRET: process.env.JWT_SECRET,
  ENCRYPTION_KEY: process.env.ENCRYPTION_KEY,
  DATABASE_URL: process.env.DATABASE_URL,
  REDIS_URL: process.env.REDIS_URL,
  CLICKHOUSE_URL: process.env.CLICKHOUSE_URL
};

module.exports = {
  apps: [
    {
      name: 'notification',
      script: './services/notification-service/dist/index.js',
      env: {
        ...commonEnv,
        PORT: 4004
      }
    },
    // ... diÄŸer servisler de commonEnv kullanmalÄ±
  ]
};
```

## Notification Service Database TablolarÄ±

Sunucuda bu tablolar MUTLAKA olmalÄ±. Yoksa 500 hatasÄ± alÄ±rsÄ±n:

```sql
-- Docker ile Ã§alÄ±ÅŸtÄ±r:
-- docker exec -i clixer_postgres psql -U clixer -d clixer << 'EOF'

-- Email Settings tablosu
CREATE TABLE IF NOT EXISTS email_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    smtp_host VARCHAR(255),
    smtp_port INTEGER DEFAULT 587,
    smtp_secure BOOLEAN DEFAULT false,
    smtp_user VARCHAR(255),
    smtp_password_encrypted TEXT,
    from_email VARCHAR(255),
    from_name VARCHAR(255),
    is_configured BOOLEAN DEFAULT false,
    last_test_at TIMESTAMP,
    last_test_result TEXT,
    created_by UUID REFERENCES users(id),
    updated_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(tenant_id)
);

-- Report Subscriptions tablosu
CREATE TABLE IF NOT EXISTS report_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    design_id UUID NOT NULL,
    design_type VARCHAR(50) NOT NULL CHECK (design_type IN ('cockpit', 'analysis')),
    recipient_user_ids UUID[] NOT NULL DEFAULT '{}',
    recipient_emails TEXT[],
    schedule_cron VARCHAR(100) NOT NULL,
    schedule_description VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    last_sent_at TIMESTAMP,
    last_error TEXT,
    send_count INTEGER DEFAULT 0,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Subscription Logs tablosu
CREATE TABLE IF NOT EXISTS subscription_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    subscription_id UUID NOT NULL REFERENCES report_subscriptions(id) ON DELETE CASCADE,
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    status VARCHAR(50) NOT NULL,
    action VARCHAR(50),
    recipients_count INTEGER,
    error_message TEXT,
    sent_at TIMESTAMP DEFAULT NOW()
);

-- Indexler
CREATE INDEX IF NOT EXISTS idx_email_settings_tenant ON email_settings(tenant_id);
CREATE INDEX IF NOT EXISTS idx_report_subscriptions_tenant ON report_subscriptions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_report_subscriptions_active ON report_subscriptions(is_active) WHERE is_active = true;
CREATE INDEX IF NOT EXISTS idx_subscription_logs_subscription ON subscription_logs(subscription_id);
```

## Users Tablosu - token_version Kolonu

Åžifre deÄŸiÅŸtirme iÃ§in gerekli:

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS token_version INTEGER DEFAULT 0;
```

## Puppeteer Chromium Kurulumu (Ubuntu)

```bash
# Sistem Chromium yÃ¼kle
sudo apt update && sudo apt install -y chromium-browser

# Puppeteer Chromium indirmesini atla
cd /opt/clixer/services/notification-service
sudo PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm install
```

## Gateway Port Binding Sorunu (EADDRINUSE)

PM2 cluster mode'da port sorunu olursa:

```bash
# Gateway'i tamamen durdur ve sil
sudo pm2 stop gateway
sudo pm2 delete gateway

# Port'u kullanan sÃ¼reÃ§leri Ã¶ldÃ¼r
sudo kill -9 $(sudo lsof -t -i :4000)

# Gateway'i yeniden derle
cd /opt/clixer/gateway
sudo npm run build

# Yeniden baÅŸlat
cd /opt/clixer
sudo pm2 start ecosystem.config.js --only gateway
```

## Deployment SÄ±rasÄ±

1. **Git Pull**
   ```bash
   cd /opt/clixer
   sudo git pull origin master
   ```

2. **Shared Module Build** (diÄŸerleri buna baÄŸÄ±mlÄ±)
   ```bash
   cd /opt/clixer/shared
   sudo npm install
   sudo npm run build
   ```

3. **Her Servis Ä°Ã§in**
   ```bash
   cd /opt/clixer/services/<service-name>
   sudo npm install
   sudo npm run build
   ```

4. **Gateway Build**
   ```bash
   cd /opt/clixer/gateway
   sudo npm install
   sudo npm run build
   ```

5. **Frontend Build** (production iÃ§in)
   ```bash
   cd /opt/clixer/frontend
   sudo npm install
   sudo npm run build
   ```

6. **PM2 Restart**
   ```bash
   cd /opt/clixer
   sudo pm2 restart all
   # veya
   sudo pm2 start ecosystem.config.js
   ```

7. **Database Migrations** (varsa)
   ```bash
   docker exec -i clixer_postgres psql -U clixer -d clixer < migrations.sql
   ```

## Log Kontrol KomutlarÄ±

```bash
# TÃ¼m servisler
sudo pm2 status

# Belirli servis loglarÄ±
sudo pm2 logs notification --lines 50
sudo pm2 logs gateway --lines 50

# Hata loglarÄ±
sudo pm2 logs --err --lines 100
```

## HÄ±zlÄ± Sorun Giderme

| Hata | Ã‡Ã¶zÃ¼m |
|------|-------|
| `JWT_SECRET environment variable is required` | ecosystem.config.js'e commonEnv ekle |
| `relation "xxx" does not exist` | YukarÄ±daki SQL'leri Ã§alÄ±ÅŸtÄ±r |
| `column "xxx" does not exist` | ALTER TABLE ile kolon ekle |
| `EADDRINUSE :4000` | Gateway port temizle ve restart |
| `404 on /api/notification/*` | Gateway rebuild + restart |
| `502 Bad Gateway` | Ä°lgili servis Ã§alÄ±ÅŸmÄ±yor, pm2 logs kontrol |

## Docker Container Ä°simleri (TavukdunyasÄ±)

```bash
# PostgreSQL
docker exec -i clixer_postgres psql -U clixer -d clixer

# Redis
docker exec -i clixer_redis redis-cli

# ClickHouse
docker exec -i clixer_clickhouse clickhouse-client
```

---

# Production GÃ¼ncellemeleri (26 Ocak 2026 - AkÅŸam Oturumu)

## 2FA Reset Ã–zelliÄŸi

Admin Panel'den kullanÄ±cÄ± 2FA'sÄ± sÄ±fÄ±rlanabilir:
- **UI**: KullanÄ±cÄ± listesinde ðŸ”‘ (anahtar) butonu
- **Endpoint**: `POST /core/users/:id/reset-2fa`
- **Dosyalar**: 
  - `services/core-service/src/routes/users.routes.ts`
  - `frontend/src/components/admin/UsersTab.tsx`

```bash
# Manuel sÄ±fÄ±rlama (acil durum)
docker exec -it clixer_postgres psql -U clixer -d clixer -c \
  "UPDATE users SET two_factor_secret = NULL, two_factor_enabled = false WHERE email = 'kullanici@email.com';"
```

## CategoryId Validation

Frontend boÅŸ string gÃ¶nderebilir, UUID hatasÄ± verir. Backend'de kontrol:

```typescript
// analytics-service/src/index.ts - POST/PUT /designs
const validCategoryId = categoryId && typeof categoryId === 'string' && categoryId.trim().length > 0 
  ? categoryId 
  : null;
```

## PM2 Kritik UyarÄ±lar

### 1. Port Conflict (EADDRINUSE)
```bash
# Servis restart Ã¶ncesi port'u temizle
sudo pm2 stop <service>
sudo fuser -k <PORT>/tcp
sudo pm2 start <service>
```

### 2. FarklÄ± PM2 Daemon Sorunu
```bash
# YANLIÅž - Root user'da yeni daemon oluÅŸturur
sudo pm2 status  # BoÅŸ liste gÃ¶sterir!

# DOÄžRU - Mevcut daemon'Ä± kullan
pm2 status  # (sudo olmadan)
# veya ecosystem.config.js ile
sudo pm2 start ecosystem.config.js
```

## Database Migration Checklist

Production'da yeni kolon eklendiÄŸinde **MUTLAKA** ALTER TABLE Ã§alÄ±ÅŸtÄ±r:

```sql
-- designs tablosu - category_id
ALTER TABLE designs ADD COLUMN IF NOT EXISTS category_id UUID;

-- report_subscriptions tablosu - yeni kolonlar
ALTER TABLE report_subscriptions ADD COLUMN IF NOT EXISTS updated_by UUID REFERENCES users(id);
ALTER TABLE report_subscriptions ADD COLUMN IF NOT EXISTS schedule_timezone VARCHAR(100) DEFAULT 'Europe/Istanbul';
ALTER TABLE report_subscriptions ADD COLUMN IF NOT EXISTS error_count INTEGER DEFAULT 0;

-- subscription_logs tablosu - yeni kolonlar
ALTER TABLE subscription_logs ADD COLUMN IF NOT EXISTS recipient_count INTEGER;
ALTER TABLE subscription_logs ADD COLUMN IF NOT EXISTS execution_time_ms INTEGER;
ALTER TABLE subscription_logs ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';
ALTER TABLE subscription_logs ADD COLUMN IF NOT EXISTS created_by UUID REFERENCES users(id);
```

## Screenshot Service - Production AyarlarÄ±

### 1. SSRF Whitelist (.env)
```bash
# Produksiyonda domain'i ekle
SCREENSHOT_ALLOWED_HOSTS=dinamo.tavukdunyasi.com,localhost,127.0.0.1
FRONTEND_URL=https://dinamo.tavukdunyasi.com
```

### 2. Hairpin NAT Sorunu
Sunucu kendi domain'ine eriÅŸemiyorsa `/etc/hosts` dÃ¼zenle:
```bash
echo "127.0.0.1 dinamo.tavukdunyasi.com" | sudo tee -a /etc/hosts
```

### 3. SSL Certificate Bypass
Self-signed certificate varsa Puppeteer'da:
```typescript
browserInstance = await puppeteer.launch({
  args: ['--ignore-certificate-errors', ...]
});
```

### 4. Browser Cache Temizleme
Her screenshot'ta fresh data iÃ§in:
```typescript
await page.setCacheEnabled(false);
await page.evaluate(() => localStorage.clear());
```

## Yeni MÃ¼ÅŸteri Kurulumu Checklist

1. âœ… Database tablolarÄ± oluÅŸtur (00-schema-and-seed.sql)
2. âœ… `.env` dosyasÄ±nda `SCREENSHOT_ALLOWED_HOSTS` ve `FRONTEND_URL` ayarla
3. âœ… `/etc/hosts` ile hairpin NAT Ã§Ã¶z (gerekirse)
4. âœ… PM2 ecosystem.config.js'te `commonEnv` kullan
5. âœ… Puppeteer Chromium kurulumu (`apt install chromium-browser`)
6. âœ… `pm2 save` ile process listesini kaydet

## HÄ±zlÄ± Deploy Script

```bash
#!/bin/bash
cd /opt/clixer
sudo git pull

# Servisleri rebuild et
for svc in core-service analytics-service data-service auth-service notification-service; do
  cd /opt/clixer/services/$svc
  sudo npm run build
done

cd /opt/clixer/gateway
sudo npm run build

# PM2 restart (port conflict Ã¶nleme)
sudo pm2 stop all
sleep 2
sudo fuser -k 4000/tcp 4001/tcp 4002/tcp 4003/tcp 4004/tcp 4005/tcp 2>/dev/null
sudo pm2 start all
sudo pm2 save
sudo pm2 status
```

---

# Production Server GÃ¼venlik KontrolÃ¼ (26 Ocak 2026)

## âš ï¸ KRÄ°TÄ°K: Docker UFW'yi Bypass Eder!

Docker container'lar varsayÄ±lan olarak `0.0.0.0` (tÃ¼m interface'ler) Ã¼zerinde port aÃ§ar. UFW kurallarÄ± Docker'Ä± ETKÄ°LEMEZ!

### Tehlikeli Durum Tespiti

```bash
# Bu Ã§Ä±ktÄ±da 0.0.0.0:PORT gÃ¶rÃ¼yorsan â†’ DIÅžARIYA AÃ‡IK!
sudo ss -tlnp | grep -E "6379|5432|8123|9000"

# Ã–rnek TEHLÄ°KELÄ° Ã§Ä±ktÄ±:
# LISTEN  0.0.0.0:6379   docker-proxy  â† Redis dÄ±ÅŸarÄ±ya aÃ§Ä±k!
# LISTEN  0.0.0.0:5432   docker-proxy  â† PostgreSQL dÄ±ÅŸarÄ±ya aÃ§Ä±k!
# LISTEN  0.0.0.0:8123   docker-proxy  â† ClickHouse dÄ±ÅŸarÄ±ya aÃ§Ä±k!
```

### Ã‡Ã¶zÃ¼m: iptables DOCKER-USER Chain

UFW yerine `iptables` ile Docker trafiÄŸini filtrele:

```bash
# 1. Network interface adÄ±nÄ± bul (eth0, ens33, ens160 vb.)
ip addr | grep -E "^[0-9]+:"

# 2. DoÄŸru interface ile kurallarÄ± ekle (Ã¶rnek: ens33)
sudo iptables -I DOCKER-USER -i ens33 -p tcp --dport 6379 -j DROP  # Redis
sudo iptables -I DOCKER-USER -i ens33 -p tcp --dport 5432 -j DROP  # PostgreSQL
sudo iptables -I DOCKER-USER -i ens33 -p tcp --dport 8123 -j DROP  # ClickHouse HTTP
sudo iptables -I DOCKER-USER -i ens33 -p tcp --dport 9000 -j DROP  # ClickHouse Native

# 3. KurallarÄ± kontrol et
sudo iptables -L DOCKER-USER -n -v

# 4. KalÄ±cÄ± kaydet (reboot sonrasÄ± da geÃ§erli)
sudo apt install iptables-persistent -y
sudo netfilter-persistent save
```

### DoÄŸrulama (DÄ±ÅŸarÄ±dan Test)

Kendi bilgisayarÄ±ndan (sunucu dÄ±ÅŸÄ±ndan) test et:

```powershell
# PowerShell ile test
Test-NetConnection -ComputerName SUNUCU_DOMAIN -Port 6379
Test-NetConnection -ComputerName SUNUCU_DOMAIN -Port 5432
Test-NetConnection -ComputerName SUNUCU_DOMAIN -Port 8123
Test-NetConnection -ComputerName SUNUCU_DOMAIN -Port 9000

# Hepsi "TcpTestSucceeded: False" olmalÄ±!
```

```bash
# Linux/Mac ile test
nc -zv SUNUCU_IP 6379
nc -zv SUNUCU_IP 5432
# "Connection refused" veya timeout olmalÄ±
```

## .env DosyasÄ± Ä°zinleri

```bash
# Sadece owner okuyabilmeli
sudo chmod 600 /opt/clixer/.env
sudo chown root:root /opt/clixer/.env  # veya clixer:clixer

# Kontrol
ls -la /opt/clixer/.env
# -rw------- olmalÄ± (600)
```

## Log DosyalarÄ±nda Åžifre KontrolÃ¼

```bash
# Åžifre/secret log'a yazÄ±lmÄ±ÅŸ mÄ± kontrol et
grep -ri "password\|secret\|key" /opt/clixer/logs/*.log | head -20
# BoÅŸ Ã§Ä±kmalÄ±!
```

## Production GÃ¼venlik Checklist

| Kontrol | Komut | Beklenen |
|---------|-------|----------|
| Redis dÄ±ÅŸarÄ±ya kapalÄ± | `nc -zv DOMAIN 6379` | Connection refused |
| PostgreSQL dÄ±ÅŸarÄ±ya kapalÄ± | `nc -zv DOMAIN 5432` | Connection refused |
| ClickHouse dÄ±ÅŸarÄ±ya kapalÄ± | `nc -zv DOMAIN 8123` | Connection refused |
| .env izinleri | `ls -la /opt/clixer/.env` | `-rw-------` |
| SSL sertifikasÄ± geÃ§erli | `openssl s_client -connect DOMAIN:443` | notAfter > bugÃ¼n |
| UFW aktif | `sudo ufw status` | Status: active |
| iptables kurallarÄ± | `sudo iptables -L DOCKER-USER -n -v` | DROP kurallarÄ± var |

## Uzun Vadeli Ã‡Ã¶zÃ¼m: docker-compose.yml

Port'larÄ± sadece localhost'a baÄŸla:

```yaml
# docker/docker-compose.yml
services:
  postgres:
    ports:
      - "127.0.0.1:5432:5432"  # Sadece localhost
  
  redis:
    ports:
      - "127.0.0.1:6379:6379"
  
  clickhouse:
    ports:
      - "127.0.0.1:8123:8123"
      - "127.0.0.1:9000:9000"
```

Bu deÄŸiÅŸiklik sonrasÄ± `docker-compose down && docker-compose up -d` gerekir.

## Nginx GÃ¼venlik Header'larÄ±

```nginx
# /etc/nginx/sites-available/clixer
server {
    # ... mevcut config ...
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
}
```

## Rate Limiting (Gateway)

Gateway'de rate limiting aktif olmalÄ±:

```typescript
// gateway/src/index.ts
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 dakika
  max: 100, // IP baÅŸÄ±na max istek
  message: 'Too many requests'
});

app.use('/api/auth', rateLimit({ windowMs: 60000, max: 5 })); // Login iÃ§in daha sÄ±kÄ±
app.use(limiter);
```

---

# Clixer Wiki / EÄŸitim Merkezi (27 Ocak 2026)

## Genel Bilgi

Clixer Wiki, kullanÄ±cÄ±lara uygulamanÄ±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± anlatan baÄŸÄ±msÄ±z bir dokÃ¼mantasyon sitesidir.

- **Konum:** `/wiki` klasÃ¶rÃ¼ (ana repo iÃ§inde)
- **Teknoloji:** React 19 + Vite 6 + TypeScript + TailwindCSS + FlexSearch
- **URL:** `{domain}/edu` (Ã¶rn: `dinamo.tavukdunyasi.com/edu`)
- **Base Path:** `/edu/` (vite.config.ts ve BrowserRouter'da tanÄ±mlÄ±)
- **Dil DesteÄŸi:** TÃ¼rkÃ§e ve Ä°ngilizce

## Sidebar Entegrasyonu

"EÄŸitim Merkezi" linki sidebar'da sadece **ADMIN rolÃ¼ne** sahip kullanÄ±cÄ±lara gÃ¶rÃ¼nÃ¼r.

```typescript
// frontend/src/components/Layout.tsx - menuItemsBase
{ id: 'education', key: 'education', href: 'education', icon: GraduationCap, badge: null, isExternal: true, adminOnly: true }
```

Dinamik URL mantÄ±ÄŸÄ±:
- Localhost: `http://localhost:3001/edu`
- Production: `{origin}/edu` (Ã¶rn: `https://dinamo.tavukdunyasi.com/edu`)

## Production Deploy

### 1. Wiki Build
```bash
cd /opt/clixer/wiki
npm install
npm run build
```

### 2. Nginx KonfigÃ¼rasyonu (HTTPS config'e ekle)

**Ã–NEMLÄ°:** Wiki location bloklarÄ± **HTTPS (443) config dosyasÄ±na** eklenmeli!
Genellikle `/etc/nginx/sites-available/default` dosyasÄ±ndaki `server { listen 443 ... }` bloÄŸuna.

`location /api` satÄ±rÄ±ndan **Ã–NCE** ÅŸu bloklarÄ± ekle:

```nginx
    # Wiki / Egitim Merkezi
    location ^~ /edu/ {
        alias /opt/clixer/wiki/dist/;
        index index.html;
        try_files $uri $uri/ /edu/index.html;
    }

    location ^~ /edu {
        return 301 /edu/;
    }
```

**Dikkat:**
- `^~` modifier'Ä± kullan (Ã¶ncelik iÃ§in)
- `/edu/` (slash ile) ve `/edu` (slash'sÄ±z) iki ayrÄ± location gerekli
- Slash'sÄ±z olan `/edu/`'ya redirect yapmalÄ±
- Bu bloklar `location /` bloÄŸunun **dÄ±ÅŸÄ±nda** ve **Ã¶nÃ¼nde** olmalÄ±

### 3. Nginx Reload
```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 4. Test
```bash
curl -I https://DOMAIN/edu/
# 200 OK dÃ¶nmeli
```

**Not:** AyrÄ± subdomain veya SSL gerekmez, mevcut domain ve SSL kullanÄ±lÄ±r.

## Ä°Ã§erik YapÄ±sÄ±

| Kategori | Makale SayÄ±sÄ± | AÃ§Ä±klama |
|----------|---------------|----------|
| BaÅŸlangÄ±Ã§ | 5 | Clixer nedir, ilk giriÅŸ, temel kavramlar |
| TasarÄ±m StÃ¼dyosu | 8 | Widget ekleme, grafik tÃ¼rleri, kaydetme |
| Metrikler | 14 | SQL modu, kolon seÃ§imi, hesaplama tipleri |
| Veri YÃ¶netimi | 9 | BaÄŸlantÄ±, dataset, ETL |
| YÃ¶netim Paneli | 9 | KullanÄ±cÄ±, RLS, pozisyon yetkileri |
| Ä°leri DÃ¼zey | 8 | 2FA, cache, LDAP, performans |

## Kritik Dosyalar

| Dosya | Sorumluluk |
|-------|------------|
| `wiki/src/content/tr/` | TÃ¼rkÃ§e makaleler |
| `wiki/src/content/en/` | Ä°ngilizce makaleler |
| `wiki/src/components/Layout.tsx` | Ana layout, dinamik Clixer linki |
| `wiki/src/utils/searchIndex.ts` | FlexSearch arama |
| `wiki/nginx.conf` | Production Nginx ÅŸablonu |

## Yeni Makale Ekleme

```typescript
// wiki/src/content/tr/{kategori}/index.ts
export const articlesTr: Article[] = [
  {
    id: 'unique-id',
    slug: 'makale-url',
    title: 'Makale BaÅŸlÄ±ÄŸÄ±',
    excerpt: 'KÄ±sa aÃ§Ä±klama',
    content: `
## Markdown iÃ§erik

AdÄ±m adÄ±m aÃ§Ä±klama...
    `,
    category: 'kategori-slug',
    categoryLabel: 'Kategori AdÄ±',
    readingTime: '5 dk',
    lastUpdated: '2026-01-27',
    tags: ['tag1', 'tag2']
  }
]
```

---

# PARAMETER Metrik Filtreleme (27 Ocak 2026)

## Problem: Cache Key Collision

PARAMETER tipindeki metrikler (combobox filtreleri) iÃ§in cache key'de `paramHash` hesaplanÄ±rken **base64 substring(0,32)** kullanÄ±lÄ±yordu. Bu yetersizdi Ã§Ã¼nkÃ¼:

- `tenantId` JSON'da ilk sÄ±rada
- FarklÄ± `designParameters` deÄŸerleri aynÄ± ilk 32 karaktere sahip oluyordu
- SonuÃ§: YanlÄ±ÅŸ cache'den dÃ¶nÃ¼ÅŸ, filtre uygulanmÄ±yor

### HatalÄ± Kod
```typescript
const paramHash = Object.keys(otherParams).length > 0 
  ? Buffer.from(JSON.stringify(otherParams)).toString('base64').substring(0, 32)
  : 'default';
```

### DÃ¼zeltilmiÅŸ Kod
```typescript
// MD5 hash kullan - base64 substring yetersiz
const paramHash = Object.keys(otherParams).length > 0 
  ? crypto.createHash('md5').update(JSON.stringify(otherParams)).digest('hex').substring(0, 16)
  : 'default';
```

## Problem: Dataset Mismatch

PARAMETER filtresi TÃœM metriklere uygulanÄ±yordu. FarklÄ± dataset kullanan metriklerde hata:
```
Unknown expression or table expression identifier 'pozisyonKadroAdiTr'
```

### Ã‡Ã¶zÃ¼m: Dataset KontrolÃ¼
```typescript
// PARAMETER filtresi SADECE aynÄ± dataset'i kullanan metriklere uygulanmalÄ±
if (paramMetric.dataset_id !== metric.dataset_id) {
  logger.debug('Parameter filter skipped - different dataset');
  continue;
}
```

## Kritik Dosyalar

| Dosya | DeÄŸiÅŸiklik |
|-------|-----------|
| `services/analytics-service/src/index.ts` | paramHash MD5, dataset kontrolÃ¼ |
| `frontend/src/components/ParameterFilterWidget.tsx` | Dropdown race condition fix |

## ParameterFilterWidget - Dropdown BoÅŸalma Sorunu

Dashboard yenilenirken `options` prop'u geÃ§ici olarak boÅŸ geliyor ve dropdown iÃ§i beyaz kalÄ±yor.

### Ã‡Ã¶zÃ¼m
```typescript
// 1. Ã–nceki geÃ§erli options'Ä± ref ile sakla
const prevOptionsRef = useRef<string[]>(options)
useEffect(() => {
  if (options.length > 0) {
    prevOptionsRef.current = options
  }
}, [options])

// 2. Stable options kullan
const stableOptions = options.length > 0 ? options : prevOptionsRef.current

// 3. Options deÄŸiÅŸtiÄŸinde dropdown'u kapat
useEffect(() => {
  if (isOpen && prevOptionsRef2.current !== options) {
    setIsOpen(false)
  }
  prevOptionsRef2.current = options
}, [options, isOpen])
```
