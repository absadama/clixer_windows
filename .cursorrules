# CLİXER - Enterprise Analytics Platform
# "Olağanüstü Veri Hızı" - Power BI / Tableau / Qlik Rakibi
# Versiyon: v4.37 | Tarih: 25 Ocak 2026

---

## ZORUNLU KOD STANDARTLARI (Enterprise)

> **BU KURALLAR ZORUNLUDUR! Her kod değişikliğinde uyulmalıdır.**

### Dosya Boyutu Limitleri

| Kural | Limit | Aşıldığında |
|-------|-------|-------------|
| Dosya boyutu | Max 500 satır | Hemen böl |
| useState sayısı | Max 10 | Zustand store'a taşı |
| Tab/Section sayısı | 3+ | Her tab ayrı component |
| Route sayısı | 5+ | Ayrı route dosyası |
| Sorumluluk | 1 dosya = 1 iş | Yeni modül oluştur |

### Yeni Özellik Ekleme Kuralları

1. **ASLA mevcut büyük dosyaya kod ekleme** - Yeni component/modül oluştur
2. **Her yeni özellik = Yeni dosya** - Mevcut dosyayı şişirme
3. **State yönetimi** - 10+ useState varsa Zustand store kullan
4. **API calls** - Custom hook'a taşı (useXxxApi.ts)
5. **Modals** - Ayrı component dosyasına çıkar

### Dosya Organizasyonu

```
frontend/src/
├── components/
│   ├── [feature]/           # Her feature kendi klasöründe
│   │   ├── FeatureTab.tsx   # Tab component
│   │   ├── FeatureModal.tsx # Modal component
│   │   └── index.ts         # Barrel export
├── hooks/
│   └── use[Feature]Api.ts   # API hook
├── stores/
│   └── [feature]Store.ts    # Zustand store
└── pages/
    └── [Feature]Page.tsx    # Sadece orchestrator (max 500 satır)

services/[service-name]/src/
├── index.ts                 # Sadece setup (max 500 satır)
├── routes/
│   └── [feature].routes.ts  # Route handlers
├── services/
│   └── [feature].service.ts # Business logic
└── helpers/
    └── [feature].helper.ts  # Utility functions
```

### Refactoring Tetikleyicileri

Aşağıdaki durumlardan biri oluştuğunda HEMEN refactor yap:

- Dosya 500 satırı geçti
- useState sayısı 10'u geçti
- Aynı kod 2+ yerde tekrarlandı
- Yeni tab/section ekleniyor
- Yeni modal ekleniyor

### Code Review Checklist

Her PR'da kontrol et:
- [ ] Dosya 500 satırı geçmiyor
- [ ] Yeni özellik ayrı dosyada
- [ ] State Zustand'da (10+ useState yoksa OK)
- [ ] API calls hook'ta
- [ ] Modals ayrı component

---

## PROAKTİF MODÜLARİZASYON (24 Ocak 2026)

> **ÖNEMLİ: Kod büyümeden ÖNCE böl! Büyüdükten sonra refactoring maliyetli.**

### Yeni Özellik Ekleme Algoritması

```
1. Yeni özellik eklemeden ÖNCE hedef dosyanın satır sayısını kontrol et
2. Eğer 400+ satırsa → YENİ DOSYA oluştur
3. Eğer useState 8+ ise → ZUSTAND STORE kullan
4. Eğer aynı kod 2. kez yazılacaksa → ORTAK MODÜLE taşı
5. HİÇBİR ZAMAN "sonra refactor ederiz" deme → ŞİMDİ yap
```

### Zustand Store Kullanım Kuralları

| Durum | Aksiyon |
|-------|---------|
| 5+ birbiriyle ilişkili useState | Store oluştur |
| State birden fazla component'te kullanılıyor | Store oluştur |
| Form state'i karmaşık | Store oluştur |
| Loading/Error state'leri çoğalıyor | Store oluştur |

### Store Pattern (Best Practice)

```typescript
// stores/[feature]Store.ts
interface FeatureState {
  // Data
  items: Item[]
  selectedItem: Item | null
  // UI State
  loading: boolean
  error: string | null
  // Modal State
  showModal: boolean
}

interface FeatureActions {
  // Setters - Functional update desteği
  setItems: (items: Item[] | ((prev: Item[]) => Item[])) => void
  // ... diğer actions
  // Reset
  reset: () => void
}

export const useFeatureStore = create<FeatureState & FeatureActions>((set) => ({
  // Initial state
  items: [],
  selectedItem: null,
  loading: false,
  error: null,
  showModal: false,
  
  // Actions with functional update support
  setItems: (itemsOrUpdater) => set((state) => ({
    items: typeof itemsOrUpdater === 'function' 
      ? itemsOrUpdater(state.items) 
      : itemsOrUpdater
  })),
  
  reset: () => set({ items: [], selectedItem: null, loading: false, error: null })
}))
```

### Auto-Refresh Pattern (ETL Progress vb.)

```typescript
// YANLIŞ - etlJobs.length değişmezse interval yenilenmez
}, [etlJobs.length])

// DOĞRU - Running job varlığına göre interval kontrol edilir
const hasRunningJobs = etlJobs.some(j => j.status === 'running' || j.status === 'pending')
useEffect(() => {
  if (!hasRunningJobs) return
  const interval = setInterval(() => loadData(), 2000)
  return () => clearInterval(interval)
}, [hasRunningJobs])
```

### Dosya Büyüme Önleme Matrisi

| Mevcut Satır | Yeni Özellik Boyutu | Aksiyon |
|--------------|---------------------|---------|
| 0-300 | Küçük (50-) | Aynı dosyaya ekle |
| 0-300 | Orta (50-150) | Aynı dosyaya ekle |
| 0-300 | Büyük (150+) | YENİ DOSYA |
| 300-400 | Küçük (50-) | Aynı dosyaya ekle |
| 300-400 | Orta (50-150) | YENİ DOSYA |
| 300-400 | Büyük (150+) | YENİ DOSYA |
| 400+ | HERHANGİ | MUTLAKA YENİ DOSYA |

---

## KRİTİK REFACTORING (23-24 Ocak 2026)

### Yapılan Değişiklikler Özeti

| Alan | Değişiklik | Etkilenen Dosyalar |
|------|------------|-------------------|
| Backend Helpers | ETL sync utilities çıkarıldı | `etl-worker/src/helpers/sync-utils.ts` |
| Backend Helpers | DB connection factory oluşturuldu | `etl-worker/src/helpers/connection-factory.ts` |
| Backend Helpers | Data service DB helpers | `data-service/src/helpers/db-connection.ts` |
| Backend Helpers | Analytics comparison/format helpers | `analytics-service/src/helpers/*.ts` |
| Frontend Hooks | API hooks oluşturuldu | `frontend/src/hooks/useDataApi.ts`, `useAdminApi.ts` |
| Frontend Components | Modal componentleri çıkarıldı | `frontend/src/components/data/ConnectionModal.tsx`, `DatasetModal.tsx` |
| API Routes | ETL Jobs endpoint düzeltildi | `data-service/src/routes/etl.routes.ts` |
| Security | Helmet.js + Rate limiting eklendi | `gateway/src/index.ts` |
| Toast System | Alert → Toast geçişi yapıldı | Tüm sayfa dosyaları |

### Hata Durumunda Bakılacak Yerler

| Hata Tipi | Kontrol Edilecek Dosya | Açıklama |
|-----------|----------------------|----------|
| ETL Job 404 | `data-service/src/routes/etl.routes.ts` | Root `/` handler ve `/etl-jobs` alias kontrolü |
| ETL Job 404 | `data-service/src/routes/index.ts` | `router.use('/etl-jobs', etlRoutes)` alias |
| DB Connection | `etl-worker/src/helpers/connection-factory.ts` | MSSQL/PostgreSQL/MySQL bağlantı factory |
| DB Connection | `data-service/src/helpers/db-connection.ts` | Data service DB helpers |
| Toast Hatası | `frontend/src/components/Toast.tsx` | `globalToast` null kontrolü |
| Toast Hatası | `frontend/src/hooks/useToast.ts` | Custom toast hook |
| API Hatası | `frontend/src/hooks/useDataApi.ts` | Data page API calls |
| API Hatası | `frontend/src/hooks/useAdminApi.ts` | Admin page API calls |
| Gateway Routing | `gateway/src/index.ts` | Proxy path'leri: `/api/data`, `/api/etl-jobs` |
| Frontend Proxy | `frontend/vite.config.ts` | Dev server `/api` proxy → localhost:4000 |

### ETL Worker Modülarizasyonu (24 Ocak 2026)

`services/etl-worker/src/index.ts` dosyası 3,922 satırdan ~1,500 satıra düşürüldü.

```
services/etl-worker/src/
├── index.ts                          # Ana setup (azaltılmış)
├── sync/
│   ├── shared.ts                     # Ortak utilities (logger, db, cache, parseColumnMapping, transformBatch)
│   ├── strategies/
│   │   ├── timestamp-sync.ts         # syncByTimestamp()
│   │   ├── id-sync.ts                # syncById()
│   │   ├── missing-ranges-sync.ts    # syncMissingRanges()
│   │   ├── new-records-sync.ts       # syncNewRecordsAfterMaxId()
│   │   ├── date-delete-insert-sync.ts# syncByDateDeleteInsert()
│   │   ├── date-partition-sync.ts    # syncByDatePartition()
│   │   ├── full-refresh-sync.ts      # fullRefresh()
│   │   └── index.ts                  # Barrel export
│   ├── databases/
│   │   ├── postgresql-sync.ts        # streamingPostgreSQLSync()
│   │   └── index.ts                  # Barrel export
│   └── index.ts                      # Main sync module export
├── validation/
│   ├── type-validator.ts             # validateTypeCompatibility(), areTypesCompatible()
│   ├── data-validator.ts             # validateDataConsistency(), checkPartitionDuplicates()
│   └── index.ts                      # Barrel export
├── locks/
│   ├── lock-manager.ts               # acquireDatasetLock(), releaseDatasetLock(), isJobCancelled()
│   └── index.ts                      # Barrel export
└── scheduler/
    ├── ldap-scheduler.ts             # checkLDAPSchedules()
    ├── etl-scheduler.ts              # checkScheduledJobs()
    └── index.ts                      # Barrel export
```

### Yeni Helper Modülleri

```
services/etl-worker/src/helpers/
├── index.ts              # Barrel export
├── sync-utils.ts         # parseColumnMapping, truncateClickHouseTable, updateJobProgress, optimizeClickHouseTable
└── connection-factory.ts # createMssqlConnection, createPostgresConnection, createMysqlConnection, executeQuery

services/data-service/src/helpers/
├── index.ts              # Barrel export
├── type-mapping.helper.ts
└── db-connection.ts      # isAzureSql, getConnectionConfig, createPostgresClient, createMssqlPool

services/analytics-service/src/helpers/
├── index.ts              # Barrel export
├── comparison.helper.ts  # getDefaultComparisonLabel, calculatePreviousPeriodDates
├── format.helper.ts      # formatDateString, escapeValue
└── rls.helper.ts         # Row-level security helpers
```

### Yeni Frontend Componentleri

```
frontend/src/components/data/
├── index.ts              # Barrel export
├── ConnectionModal.tsx   # Bağlantı oluşturma/düzenleme modal
└── DatasetModal.tsx      # Dataset oluşturma modal

frontend/src/hooks/
├── useDataApi.ts         # DataPage API hook
├── useAdminApi.ts        # AdminPage API hook
└── useToast.ts           # Toast notification hook
```

### TypeScript Build Kontrolleri

Build hatası alındığında sırayla kontrol et:
1. `frontend/src/components/Toast.tsx` - void expression kontrolü
2. `frontend/src/pages/AdminPage.tsx` - userForm state'inde `categories`, `canSeeAllCategories` var mı?
3. `frontend/src/pages/DesignerPage.tsx` - `import toast from 'react-hot-toast'` var mı?

### Frontend useState Azaltma (24 Ocak 2026)

> **KRİTİK BAŞARI:** useState ihlalleri düzeltildi, enterprise standartlara uyum sağlandı.

| Sayfa | Önce | Sonra | Store |
|-------|------|-------|-------|
| AdminPage.tsx | 76 useState | 8 useState | `adminStore.ts` |
| DesignerPage.tsx | 23 useState | 6 useState | `designerStore.ts` (YENİ) |
| DataPage.tsx | 18 useState | 1 useState | `dataStore.ts` (YENİ) |

### Yeni Frontend Stores (24 Ocak 2026)

```
frontend/src/stores/
├── adminStore.ts      # Admin panel state (mevcut, genişletildi)
├── designerStore.ts   # Designer page state (YENİ)
├── dataStore.ts       # Data page state (YENİ)
├── authStore.ts       # Auth state
├── filterStore.ts     # Filter state
├── themeStore.ts      # Theme state
└── settingsStore.ts   # Settings state
```

#### designerStore.ts İçeriği
- `designs`, `widgets`, `layouts` - Design data
- `selectedDesign`, `selectedWidget` - Selection state
- `metrics`, `reportCategories` - Reference data
- `loading`, `error` - Async state
- Tüm setter'lar functional update destekli

#### dataStore.ts İçeriği
- `connections`, `datasets`, `etlJobs`, `schedules` - Data
- `workerStatus`, `systemHealth` - Status
- Modal state'leri (`showConnectionModal`, `showDatasetModal` vb.)
- Re-exported types: `Connection`, `Dataset`, `ETLJob`, `Schedule`, vb.

### Auto-Refresh Düzeltmesi (24 Ocak 2026)

**Problem:** ETL progress bar canlı güncellenmiyor
**Sebep:** `[etlJobs.length]` dependency array - job sayısı değişmezse interval yenilenmiyordu
**Çözüm:** `hasRunningJobs` boolean değerine göre interval kontrol

```typescript
// DataPage.tsx - düzeltilmiş
const hasRunningJobs = etlJobs.some(j => j.status === 'running' || j.status === 'pending')
useEffect(() => {
  if (!hasRunningJobs) return
  const interval = setInterval(() => loadETLJobs(), 2000)
  return () => clearInterval(interval)
}, [hasRunningJobs])
```

---

## DOKÜMANTASYON YAPISI (23 Ocak 2026)

Bu dosya optimize edilmiştir. Detaylı bilgiler aşağıdaki dosyalarda:

| Dosya | İçerik | Ne Zaman Oku |
|-------|--------|--------------|
| `docs/architecture.md` | Mimari, servisler, veritabanı, akışlar | Yeni özellik eklerken |
| `docs/troubleshooting.md` | Hata çözümleri, debugging | Hata ayıklarken |
| `docs/history/versions.md` | Tüm versiyon geçmişi (v2.0 - v4.32) | Geçmiş araştırırken |
| `docs/cursorrules_backup_20260115.md` | Orijinal 9878 satırlık yedek | Acil durumda |

---

## CURSOR AI - KRİTİK KURALLAR

### 1. LFL & Ranking List (ÖNEMLİ)
Ranking list (TOP10) widget'larında LFL hesaplanırken:
- `metric.comparison_type === 'lfl'` ve `rankingChartConfig.lflCalendarDatasetId` kontrolü yapılmalı.
- SQL oluşturulurken dış SELECT'te kolon adı yerine subquery alias'ı (`grp_col`) kullanılmalı.

### 2. Token Validation & 401 Race Condition
`App.tsx` içerisinde `Layout` render edilmeden önce MUTLAKA `/auth/verify` endpoint'i ile token doğrulanmalı. Aksi takdirde refresh anında expired token ile çoklu API çağrısı yapılıp 401 hatalarına neden olur.

### 3. White-Label & Dinamik Etiketler
Mağaza, Bölge ve Grup isimleri kod içerisinde hardcoded (örn: "Mağaza") kullanılmamalıdır. Her zaman `settingsStore`'dan (`storeLabel`, `storeLabelPlural` vb.) okunmalıdır.

### 4. UI Filtre Kontrolleri
FilterBar ve Dashboard'da filtre butonları gösterilmeden önce verinin varlığı (`stores.length > 0`) kontrol edilmelidir. Boş liste durumunda "Mağaza Seçin" butonu gizlenmelidir.

### 5. Yeni Müşteri (Tenant) Setup
Yeni kurulumlarda veya ayarlar gelmediğinde Admin Panel > Sistem Ayarları > "Varsayılanları Yükle" butonu kullanılmalıdır.

### 6. Test Edilmeden Rules'a Yazma
Kullanıcıdan "başarılı/çalıştı" mesajı gelmeden .cursorrules'a güncelleme YAPMA!

### 7. Git Push Zorunlu
Commit sonrası MUTLAKA `git push origin master` yap. Push edilmemiş kod = Production'da YOK.

### 8. Proaktif Modülarizasyon (24 Ocak 2026)
Yeni özellik eklerken:
1. **ÖNCE** hedef dosyanın satır sayısını kontrol et
2. **400+ satır** varsa MUTLAKA yeni dosya oluştur
3. **8+ useState** varsa MUTLAKA Zustand store kullan
4. **"Sonra refactor ederiz"** DEMEKTİ YASAK - hemen yap
5. Mevcut dosyayı şişirmek yerine **yeni modül oluştur**

### 9. Store Setter Pattern
Zustand setter'lar hem doğrudan değer hem functional update desteklemeli:
```typescript
setItems: (itemsOrUpdater) => set((state) => ({
  items: typeof itemsOrUpdater === 'function' 
    ? itemsOrUpdater(state.items) 
    : itemsOrUpdater
}))
```

### 10. useEffect Dependency Dikkat
Array state'lerde `.length` yerine gerçek kontrol değerini kullan:
```typescript
// YANLIŞ: jobs.length
// DOĞRU: jobs.some(j => j.status === 'running')
```

### 11. API Routing Kuralları (Gateway → Service Mapping)
Frontend'de API çağrısı yaparken doğru servis prefix'ini kullan:
```typescript
// Gateway routing:
// /api/auth/*     → Auth Service (4001)
// /api/core/*     → Core Service (4002)
// /api/data/*     → Data Service (4003)
// /api/analytics/* → Analytics Service (4005)
// /api/admin/redis|postgres|clickhouse|system/* → Data Service
// /api/admin/*    → Core Service (catch-all)

// ÖRNEK - Backup endpoint:
// YANLIŞ: apiCall('/core/backups')      // Core Service'te yok!
// DOĞRU:  apiCall('/data/admin/backup/list')  // Data Service'te var

// ÖRNEK - Sessions endpoint:
// YANLIŞ: apiCall('/core/sessions')     // Core Service'te yok!
// DOĞRU:  apiCall('/data/admin/sessions')    // Data Service'te var
```

### 12. Component Mount Data Loading Pattern
Her Tab/Page component'i mount olduğunda veri yüklemeli:
```typescript
// ZORUNLU: useEffect ile ilk yükleme
useEffect(() => {
  loadData()
// eslint-disable-next-line react-hooks/exhaustive-deps
}, [])

// YANLIŞ: Sadece "Yenile" butonuna bağlı bırakmak
// Kullanıcı sayfaya girince boş ekran görür!
```

### 13. Store Type Re-Export Kuralı
Store'dan dışa aktarılan tipler, tüketen component'lerde import edilebilmeli:
```typescript
// stores/dataStore.ts
export type { Connection, Dataset, ETLJob } from '../types/data'

// Component'te kullanım:
import { useDataStore, Connection, Dataset } from '../stores/dataStore'
// VEYA
import type { Connection } from '../stores/dataStore'
```

### 14. PostgreSQL JSONB Parsing (25 Ocak 2026)
PostgreSQL node driver JSONB kolonları otomatik JavaScript objesine çevirir.
`JSON.parse()` çağırma - zaten object!
```typescript
// YANLIŞ - Obje üzerinde JSON.parse hata verir
const parsed = JSON.parse(dbRow.jsonbColumn);

// DOĞRU - Önce tip kontrolü
if (typeof dbRow.jsonbColumn === 'object') {
  // Zaten parse edilmiş, direkt kullan
  const value = dbRow.jsonbColumn.value;
} else if (typeof dbRow.jsonbColumn === 'string') {
  // String ise parse et
  const parsed = JSON.parse(dbRow.jsonbColumn);
}
```

### 15. 2FA Setup Response Kontrolü
Login endpoint'i 2FA zorunlu ama kurulu değilse:
```typescript
// Response:
{ success: false, requires2FASetup: true, setupToken: "..." }

// Frontend bu response'u alınca QR ekranı göstermeli
```

---

## GÜVENLİK İMPLEMENTASYONLARI (25 Ocak 2026 - v2)

> **Detaylı bilgi:** `.cursor/rules/security-implementations.mdc`

### Yapılan Güvenlik Geliştirmeleri

| Özellik | Açıklama | Dosyalar |
|---------|----------|----------|
| 2FA (Google Authenticator) | Sistem geneli zorunlu 2FA | `auth-service/index.ts`, `LoginPage.tsx` |
| 2FA Setup Token Tek Kullanım | Token reuse engellendi | `auth-service/index.ts` |
| Purpose Token Koruması | 2fa_setup token genel endpoint'lerde reddedilir | `shared/auth.ts` |
| LDAP Backdoor Fix | Fallback kaldırıldı | `auth-service/index.ts` |
| Trusted Device IP/UA Binding | Token çalınsa bile kullanılamaz | `auth-service/index.ts` |
| Password Encryption Fix | Connection password şifreleme | `data-service/index.ts` |
| Position Permissions | SUPER_ADMIN only | `core-service/positions.routes.ts` |
| Analytics Authorization | SUPER_ADMIN/ADMIN kontrolü | `analytics-service/index.ts` |
| Gateway IP Spoofing Fix | req.ip kullanımı | `gateway/index.ts` |
| Redis Fail-Closed | Production'da fail-closed | `shared/auth.ts` |
| SSRF DNS Rebinding | DNS çözümleme doğrulaması | `shared/security.ts` |
| Rate Limit Fix | Socket IP kullanımı | `auth-service/index.ts` |

### Production Status: ✅ AÇILABILIR

### 2FA Kritik Bilgiler

```typescript
// PostgreSQL JSONB kolonlar otomatik parse edilir!
// YANLIŞ:
const parsed = JSON.parse(twoFactorSetting.value); // HATA!

// DOĞRU:
if (typeof val === 'object') {
  systemRequires2FA = val.value === 'true';
}
```

### 2FA Test

```powershell
# 2FA setup response kontrolü
$body = '{"email":"admin@clixer","password":"Admin123!"}'
Invoke-WebRequest -Uri "http://localhost:4001/login" -Method POST -ContentType "application/json" -Body $body
# Beklenen: {"requires2FASetup":true,"setupToken":"..."}
```

---

## DOKUNMA! KORUNAN DOSYALAR

> **KULLANICI AÇIKÇA İSTEMEDİKÇE BU DOSYALARA ASLA DOKUNMA!**

| Dosya | Neden Korunuyor |
|-------|-----------------|
| `frontend/src/components/FilterBar.tsx` | Bölge/Grup/Mağaza seçici - v4.32'de dinamik etiketlendi |
| `frontend/src/stores/filterStore.ts` | Filtre state yönetimi - kritik bağımlılıklar var |
| `frontend/src/pages/DashboardPage.tsx` | Filtre entegrasyonu |
| `frontend/src/pages/AnalysisPage.tsx` | Filtre entegrasyonu |
| `services/analytics-service/src/index.ts` | storeIds/regionIds/groupIds ve LFL mantığı |
| `services/etl-worker/src/helpers/*` | 23 Ocak refactoring - sync utilities |
| `services/data-service/src/helpers/*` | 23 Ocak refactoring - DB connection helpers |
| `frontend/src/components/data/*` | 23 Ocak refactoring - Extracted modals |
| `frontend/src/stores/designerStore.ts` | 24 Ocak - Designer state management |
| `frontend/src/stores/dataStore.ts` | 24 Ocak - Data page state management |
| `frontend/src/stores/adminStore.ts` | 24 Ocak - Admin state (genişletildi) |
| `services/auth-service/src/index.ts` | 25 Ocak - 2FA, login, session security |
| `shared/src/auth.ts` | 25 Ocak - Purpose token, blacklist, fail-closed |
| `shared/src/security.ts` | 25 Ocak - SSRF, encryption, sanitization |
| `gateway/src/index.ts` | 25 Ocak - IP spoofing fix, rate limiting |
| `services/core-service/src/routes/positions.routes.ts` | 25 Ocak - SUPER_ADMIN only |
| `frontend/src/stores/authStore.ts` | 25 Ocak - 2FA setup state |
| `frontend/src/pages/LoginPage.tsx` | 25 Ocak - 2FA setup UI |
| `shared/src/auth.ts` | 25 Ocak - Token blacklist, validation |
| `shared/src/security.ts` | 25 Ocak - SSRF protection |

**Stabil Versiyon:** v4.37 (25 Ocak 2026)

---

## PROJE ÖZETİ
**Clixer**, kurumsal analitik platformudur. Perakende, F&B, üniversite, holding sektörlerinde kullanılır.
**Fark:** Real-time WebSocket, Offline PWA, Delta Sync, White-label, No-code ETL

---

## MİMARİ
### Servisler ve Portlar

| Servis | Port | Sorumluluk |
|--------|------|------------|
| gateway | 4000 | API routing, proxy |
| auth-service | 4001 | Login, JWT, 2FA |
| core-service | 4002 | Users, Tenants, Designs, Settings |
| data-service | 4003 | Connections, Datasets, ETL, ClickHouse |
| notification-service | 4004 | Alerts, Email, WebSocket |
| analytics-service | 4005 | KPI okuma, Cache, Aggregation |
| etl-worker | - | Background ETL jobs |

### Veritabanları

| DB | Kullanım |
|----|----------|
| PostgreSQL | Config, users, settings (OLTP) |
| ClickHouse | Analitik veriler (OLAP) |
| Redis | Cache, Pub/Sub, Queue |

### Temel Akış
```
Müşteri DB → ETL → ClickHouse → Redis Cache → Dashboard
```

---

## MÜŞTERİ DEPLOY KOMUTU

```bash
cd /opt/clixer && sudo git fetch origin && sudo git reset --hard origin/master && sudo bash scripts/stop-all.sh && sudo bash scripts/migrate-report-categories.sh && cd frontend && sudo rm -rf dist && sudo npm run build && sudo chown -R www-data:www-data dist && sudo systemctl restart nginx && cd /opt/clixer && sudo bash scripts/start-all.sh && echo "Deploy tamamlandı!"
```

**NOT:** `migrate-report-categories.sh` (v4.33) veritabanı şemasını (Rapor Kategorileri / Güçler Ayrılığı) otomatik günceller.

---

## PRODUCTION NOTLARI
### Systemd Servisleri
Linux'ta servisler systemd ile yönetilir:
```bash
sudo /opt/clixer/scripts/setup-services.sh  # Kurulum
sudo systemctl status clixer-*              # Durum
sudo /opt/clixer/scripts/restart-all.sh     # Restart
```

### NPM Yolu Standardizasyonu
Farklı Node.js kurulumları için `setup-services.sh` otomatik symlink oluşturur:
```bash
ln -sf $(which npm) /usr/bin/npm
```

### Restart Sistemi
UI'dan "Sistemi Yeniden Başlat" butonu (Admin Panel > Sistem Monitörü):
- Windows: `scripts/restart-local.ps1`
- Linux: `scripts/restart-all.sh`

Sudoers gerekli: `clixer ALL=(ALL) NOPASSWD: /opt/clixer/scripts/restart-all.sh`

---

## STABİL MÜŞTERİLER

| Müşteri | Versiyon | Tarih | Durum |
|---------|----------|-------|-------|
| Tavuk Dünyası (TD) | v4.32 | 19 Ocak 2026 | STABİL |
| Nişantaşı Üniv | v4.32 | 19 Ocak 2026 | STABİL |

**Not:** v4.36 refactoring (23-24 Ocak) henüz production'a deploy edilmedi. Deploy öncesi test gerekli.

---

## HIZLI SORUN GİDERME (23 Ocak 2026)

### Servis Sağlık Kontrolü
```powershell
# Tüm servisleri kontrol et
@(4000,4001,4002,4003,4005,3000) | ForEach-Object { 
  try { Invoke-WebRequest "http://localhost:$_/health" -TimeoutSec 2 | Out-Null; "OK: $_" } 
  catch { "FAIL: $_" } 
}
```

### API Test (Login + Token)
```powershell
$body = '{"email":"admin@clixer","password":"Admin1234!"}'
$login = Invoke-RestMethod -Uri "http://localhost:4000/api/auth/login" -Method POST -Body $body -ContentType "application/json"
$token = $login.data.accessToken
$headers = @{ Authorization = "Bearer $token" }

# Test endpoints
Invoke-RestMethod "http://localhost:4000/api/data/etl-jobs" -Headers $headers
Invoke-RestMethod "http://localhost:4000/api/data/connections" -Headers $headers
Invoke-RestMethod "http://localhost:4000/api/analytics/designs" -Headers $headers
```

### Sık Karşılaşılan Hatalar

| Hata | Sebep | Çözüm |
|------|-------|-------|
| 404 /api/data/etl-jobs | Route alias eksik | `etl.routes.ts` root handler kontrol |
| JSON parse error (<!DOCTYPE) | Backend kapalı | `CLIXER-BASLAT.bat` çalıştır |
| Toast undefined | globalToast null | `Toast.tsx` if-else kontrolü |
| TS2345 AdminPage | userForm eksik field | `categories`, `canSeeAllCategories` ekle |
| TS2304 toast | Import eksik | `import toast from 'react-hot-toast'` |

---

## TEKNOLOJİ
- **Frontend:** React 19, TypeScript, Vite, Zustand, TailwindCSS
- **Backend:** Node.js, Express, TypeScript
- **Mobile:** Capacitor (PWA + Native)
- **Infra:** Docker, systemd, Nginx

---

## DETAYLI BİLGİ İÇİN

| İhtiyaç | Dosya | Kullanım |
|---------|-------|----------|
| Mimari bilgi | `@docs/architecture.md` | Yeni özellik, servis yapısı, veritabanı |
| Hata çözümü | `@docs/troubleshooting.md` | Debug, error, sorun giderme |
| Geçmiş bilgi | `@docs/history/versions.md` | Versiyon notları, eski değişiklikler |
| Tam yedek | `docs/cursorrules_backup_20260115.md` | Acil durumda tüm eski bilgiler |

**Cursor AI:** Bu dosyaları gerektiğinde oku veya kullanıcı `@dosya` ile referans versin.

---

## PRODUCTION DEPLOYMENT (v4.36+)

### Kritik Deployment Gereksinimleri

| Gereksinim | Açıklama |
|------------|----------|
| `EnvironmentFile` | Tüm systemd servislerde `/opt/clixer/.env` yüklenmeli |
| `pg` paketi | Gateway'de `npm install pg` gerekli (IP whitelist için) |
| `JWT_SECRET` | .env'de en az 32 karakter olmalı |
| `ENCRYPTION_KEY` | .env'de `openssl rand -hex 32` ile üretilmeli |
| `CORS_ORIGIN` | `*` DEĞİL, spesifik domain olmalı |

### Database Migration'ları (v4.36)

```sql
-- users tablosu
ALTER TABLE users ADD COLUMN IF NOT EXISTS can_see_all_categories BOOLEAN DEFAULT false;
ALTER TABLE users ADD COLUMN IF NOT EXISTS filter_level VARCHAR(50) DEFAULT 'store';
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone_number VARCHAR(20);
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone_active BOOLEAN DEFAULT true;

-- report_categories tablosu (code kolonu dahil)
-- user_report_categories tablosu (assigned_by, assigned_at dahil)
-- navigation_items tablosu
```

### Systemd EnvironmentFile Ekleme

```bash
for f in /etc/systemd/system/clixer-*.service; do
  sudo grep -q "EnvironmentFile" "$f" || sudo sed -i '/WorkingDirectory=/a EnvironmentFile=/opt/clixer/.env' "$f"
done
sudo systemctl daemon-reload
```

### Firewall Güvenliği

```bash
# 4000 ve 3000 portları KAPALI olmalı
sudo ufw delete allow 4000/tcp
sudo ufw delete allow 3000/tcp
# Sadece 22, 80, 443 açık olmalı
```

### Deploy Dosyaları

| Dosya | Kullanım |
|-------|----------|
| `deploy/PRODUCTION-DEPLOYMENT-CHECKLIST.md` | Tam adım adım rehber |
| `deploy/QUICK-DEPLOY.md` | Hızlı referans |
| `deploy/migrate-v436.sh` | Otomatik migration script |

---
