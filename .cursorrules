# CLİXER - Enterprise Analytics Platform
# "Olağanüstü Veri Hızı" - Power BI / Tableau / Qlik Rakibi
# Versiyon: v4.34 | Tarih: 23 Ocak 2026

---

## KRİTİK REFACTORING (23 Ocak 2026)

### Yapılan Değişiklikler Özeti

| Alan | Değişiklik | Etkilenen Dosyalar |
|------|------------|-------------------|
| Backend Helpers | ETL sync utilities çıkarıldı | `etl-worker/src/helpers/sync-utils.ts` |
| Backend Helpers | DB connection factory oluşturuldu | `etl-worker/src/helpers/connection-factory.ts` |
| Backend Helpers | Data service DB helpers | `data-service/src/helpers/db-connection.ts` |
| Backend Helpers | Analytics comparison/format helpers | `analytics-service/src/helpers/*.ts` |
| Frontend Hooks | API hooks oluşturuldu | `frontend/src/hooks/useDataApi.ts`, `useAdminApi.ts` |
| Frontend Components | Modal componentleri çıkarıldı | `frontend/src/components/data/ConnectionModal.tsx`, `DatasetModal.tsx` |
| API Routes | ETL Jobs endpoint düzeltildi | `data-service/src/routes/etl.routes.ts` |
| Security | Helmet.js + Rate limiting eklendi | `gateway/src/index.ts` |
| Toast System | Alert → Toast geçişi yapıldı | Tüm sayfa dosyaları |

### Hata Durumunda Bakılacak Yerler

| Hata Tipi | Kontrol Edilecek Dosya | Açıklama |
|-----------|----------------------|----------|
| ETL Job 404 | `data-service/src/routes/etl.routes.ts` | Root `/` handler ve `/etl-jobs` alias kontrolü |
| ETL Job 404 | `data-service/src/routes/index.ts` | `router.use('/etl-jobs', etlRoutes)` alias |
| DB Connection | `etl-worker/src/helpers/connection-factory.ts` | MSSQL/PostgreSQL/MySQL bağlantı factory |
| DB Connection | `data-service/src/helpers/db-connection.ts` | Data service DB helpers |
| Toast Hatası | `frontend/src/components/Toast.tsx` | `globalToast` null kontrolü |
| Toast Hatası | `frontend/src/hooks/useToast.ts` | Custom toast hook |
| API Hatası | `frontend/src/hooks/useDataApi.ts` | Data page API calls |
| API Hatası | `frontend/src/hooks/useAdminApi.ts` | Admin page API calls |
| Gateway Routing | `gateway/src/index.ts` | Proxy path'leri: `/api/data`, `/api/etl-jobs` |
| Frontend Proxy | `frontend/vite.config.ts` | Dev server `/api` proxy → localhost:4000 |

### Yeni Helper Modülleri

```
services/etl-worker/src/helpers/
├── index.ts              # Barrel export
├── sync-utils.ts         # parseColumnMapping, truncateClickHouseTable, updateJobProgress, optimizeClickHouseTable
└── connection-factory.ts # createMssqlConnection, createPostgresConnection, createMysqlConnection, executeQuery

services/data-service/src/helpers/
├── index.ts              # Barrel export
├── type-mapping.helper.ts
└── db-connection.ts      # isAzureSql, getConnectionConfig, createPostgresClient, createMssqlPool

services/analytics-service/src/helpers/
├── index.ts              # Barrel export
├── comparison.helper.ts  # getDefaultComparisonLabel, calculatePreviousPeriodDates
├── format.helper.ts      # formatDateString, escapeValue
└── rls.helper.ts         # Row-level security helpers
```

### Yeni Frontend Componentleri

```
frontend/src/components/data/
├── index.ts              # Barrel export
├── ConnectionModal.tsx   # Bağlantı oluşturma/düzenleme modal
└── DatasetModal.tsx      # Dataset oluşturma modal

frontend/src/hooks/
├── useDataApi.ts         # DataPage API hook
├── useAdminApi.ts        # AdminPage API hook
└── useToast.ts           # Toast notification hook
```

### TypeScript Build Kontrolleri

Build hatası alındığında sırayla kontrol et:
1. `frontend/src/components/Toast.tsx` - void expression kontrolü
2. `frontend/src/pages/AdminPage.tsx` - userForm state'inde `categories`, `canSeeAllCategories` var mı?
3. `frontend/src/pages/DesignerPage.tsx` - `import toast from 'react-hot-toast'` var mı?

---

## DOKÜMANTASYON YAPISI (23 Ocak 2026)

Bu dosya optimize edilmiştir. Detaylı bilgiler aşağıdaki dosyalarda:

| Dosya | İçerik | Ne Zaman Oku |
|-------|--------|--------------|
| `docs/architecture.md` | Mimari, servisler, veritabanı, akışlar | Yeni özellik eklerken |
| `docs/troubleshooting.md` | Hata çözümleri, debugging | Hata ayıklarken |
| `docs/history/versions.md` | Tüm versiyon geçmişi (v2.0 - v4.32) | Geçmiş araştırırken |
| `docs/cursorrules_backup_20260115.md` | Orijinal 9878 satırlık yedek | Acil durumda |

---

## CURSOR AI - KRİTİK KURALLAR

### 1. LFL & Ranking List (ÖNEMLİ)
Ranking list (TOP10) widget'larında LFL hesaplanırken:
- `metric.comparison_type === 'lfl'` ve `rankingChartConfig.lflCalendarDatasetId` kontrolü yapılmalı.
- SQL oluşturulurken dış SELECT'te kolon adı yerine subquery alias'ı (`grp_col`) kullanılmalı.

### 2. Token Validation & 401 Race Condition
`App.tsx` içerisinde `Layout` render edilmeden önce MUTLAKA `/auth/verify` endpoint'i ile token doğrulanmalı. Aksi takdirde refresh anında expired token ile çoklu API çağrısı yapılıp 401 hatalarına neden olur.

### 3. White-Label & Dinamik Etiketler
Mağaza, Bölge ve Grup isimleri kod içerisinde hardcoded (örn: "Mağaza") kullanılmamalıdır. Her zaman `settingsStore`'dan (`storeLabel`, `storeLabelPlural` vb.) okunmalıdır.

### 4. UI Filtre Kontrolleri
FilterBar ve Dashboard'da filtre butonları gösterilmeden önce verinin varlığı (`stores.length > 0`) kontrol edilmelidir. Boş liste durumunda "Mağaza Seçin" butonu gizlenmelidir.

### 5. Yeni Müşteri (Tenant) Setup
Yeni kurulumlarda veya ayarlar gelmediğinde Admin Panel > Sistem Ayarları > "Varsayılanları Yükle" butonu kullanılmalıdır.

### 6. Test Edilmeden Rules'a Yazma
Kullanıcıdan "başarılı/çalıştı" mesajı gelmeden .cursorrules'a güncelleme YAPMA!

### 7. Git Push Zorunlu
Commit sonrası MUTLAKA `git push origin master` yap. Push edilmemiş kod = Production'da YOK.

---

## DOKUNMA! KORUNAN DOSYALAR

> **KULLANICI AÇIKÇA İSTEMEDİKÇE BU DOSYALARA ASLA DOKUNMA!**

| Dosya | Neden Korunuyor |
|-------|-----------------|
| `frontend/src/components/FilterBar.tsx` | Bölge/Grup/Mağaza seçici - v4.32'de dinamik etiketlendi |
| `frontend/src/stores/filterStore.ts` | Filtre state yönetimi - kritik bağımlılıklar var |
| `frontend/src/pages/DashboardPage.tsx` | Filtre entegrasyonu |
| `frontend/src/pages/AnalysisPage.tsx` | Filtre entegrasyonu |
| `services/analytics-service/src/index.ts` | storeIds/regionIds/groupIds ve LFL mantığı |
| `services/etl-worker/src/helpers/*` | 23 Ocak refactoring - sync utilities |
| `services/data-service/src/helpers/*` | 23 Ocak refactoring - DB connection helpers |
| `frontend/src/components/data/*` | 23 Ocak refactoring - Extracted modals |

**Stabil Versiyon:** v4.34 (23 Ocak 2026)

---

## PROJE ÖZETİ
**Clixer**, kurumsal analitik platformudur. Perakende, F&B, üniversite, holding sektörlerinde kullanılır.
**Fark:** Real-time WebSocket, Offline PWA, Delta Sync, White-label, No-code ETL

---

## MİMARİ
### Servisler ve Portlar

| Servis | Port | Sorumluluk |
|--------|------|------------|
| gateway | 4000 | API routing, proxy |
| auth-service | 4001 | Login, JWT, 2FA |
| core-service | 4002 | Users, Tenants, Designs, Settings |
| data-service | 4003 | Connections, Datasets, ETL, ClickHouse |
| notification-service | 4004 | Alerts, Email, WebSocket |
| analytics-service | 4005 | KPI okuma, Cache, Aggregation |
| etl-worker | - | Background ETL jobs |

### Veritabanları

| DB | Kullanım |
|----|----------|
| PostgreSQL | Config, users, settings (OLTP) |
| ClickHouse | Analitik veriler (OLAP) |
| Redis | Cache, Pub/Sub, Queue |

### Temel Akış
```
Müşteri DB → ETL → ClickHouse → Redis Cache → Dashboard
```

---

## MÜŞTERİ DEPLOY KOMUTU

```bash
cd /opt/clixer && sudo git fetch origin && sudo git reset --hard origin/master && sudo bash scripts/stop-all.sh && sudo bash scripts/migrate-report-categories.sh && cd frontend && sudo rm -rf dist && sudo npm run build && sudo chown -R www-data:www-data dist && sudo systemctl restart nginx && cd /opt/clixer && sudo bash scripts/start-all.sh && echo "Deploy tamamlandı!"
```

**NOT:** `migrate-report-categories.sh` (v4.33) veritabanı şemasını (Rapor Kategorileri / Güçler Ayrılığı) otomatik günceller.

---

## PRODUCTION NOTLARI
### Systemd Servisleri
Linux'ta servisler systemd ile yönetilir:
```bash
sudo /opt/clixer/scripts/setup-services.sh  # Kurulum
sudo systemctl status clixer-*              # Durum
sudo /opt/clixer/scripts/restart-all.sh     # Restart
```

### NPM Yolu Standardizasyonu
Farklı Node.js kurulumları için `setup-services.sh` otomatik symlink oluşturur:
```bash
ln -sf $(which npm) /usr/bin/npm
```

### Restart Sistemi
UI'dan "Sistemi Yeniden Başlat" butonu (Admin Panel > Sistem Monitörü):
- Windows: `scripts/restart-local.ps1`
- Linux: `scripts/restart-all.sh`

Sudoers gerekli: `clixer ALL=(ALL) NOPASSWD: /opt/clixer/scripts/restart-all.sh`

---

## STABİL MÜŞTERİLER

| Müşteri | Versiyon | Tarih | Durum |
|---------|----------|-------|-------|
| Tavuk Dünyası (TD) | v4.32 | 19 Ocak 2026 | STABİL |
| Nişantaşı Üniv | v4.32 | 19 Ocak 2026 | STABİL |

---

## HIZLI SORUN GİDERME (23 Ocak 2026)

### Servis Sağlık Kontrolü
```powershell
# Tüm servisleri kontrol et
@(4000,4001,4002,4003,4005,3000) | ForEach-Object { 
  try { Invoke-WebRequest "http://localhost:$_/health" -TimeoutSec 2 | Out-Null; "OK: $_" } 
  catch { "FAIL: $_" } 
}
```

### API Test (Login + Token)
```powershell
$body = '{"email":"admin@clixer","password":"Admin1234!"}'
$login = Invoke-RestMethod -Uri "http://localhost:4000/api/auth/login" -Method POST -Body $body -ContentType "application/json"
$token = $login.data.accessToken
$headers = @{ Authorization = "Bearer $token" }

# Test endpoints
Invoke-RestMethod "http://localhost:4000/api/data/etl-jobs" -Headers $headers
Invoke-RestMethod "http://localhost:4000/api/data/connections" -Headers $headers
Invoke-RestMethod "http://localhost:4000/api/analytics/designs" -Headers $headers
```

### Sık Karşılaşılan Hatalar

| Hata | Sebep | Çözüm |
|------|-------|-------|
| 404 /api/data/etl-jobs | Route alias eksik | `etl.routes.ts` root handler kontrol |
| JSON parse error (<!DOCTYPE) | Backend kapalı | `CLIXER-BASLAT.bat` çalıştır |
| Toast undefined | globalToast null | `Toast.tsx` if-else kontrolü |
| TS2345 AdminPage | userForm eksik field | `categories`, `canSeeAllCategories` ekle |
| TS2304 toast | Import eksik | `import toast from 'react-hot-toast'` |

---

## TEKNOLOJİ
- **Frontend:** React 19, TypeScript, Vite, Zustand, TailwindCSS
- **Backend:** Node.js, Express, TypeScript
- **Mobile:** Capacitor (PWA + Native)
- **Infra:** Docker, systemd, Nginx

---

## DETAYLI BİLGİ İÇİN

| İhtiyaç | Dosya | Kullanım |
|---------|-------|----------|
| Mimari bilgi | `@docs/architecture.md` | Yeni özellik, servis yapısı, veritabanı |
| Hata çözümü | `@docs/troubleshooting.md` | Debug, error, sorun giderme |
| Geçmiş bilgi | `@docs/history/versions.md` | Versiyon notları, eski değişiklikler |
| Tam yedek | `docs/cursorrules_backup_20260115.md` | Acil durumda tüm eski bilgiler |

**Cursor AI:** Bu dosyaları gerektiğinde oku veya kullanıcı `@dosya` ile referans versin.

---
