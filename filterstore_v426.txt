/**
 * Clixer - Global Filter Store
 * T├╝m sayfalarda kullan─▒lan ma─şaza/b├Âlge/tarih filtreleri
 */

import { create } from 'zustand'

const API_BASE = import.meta.env.VITE_API_URL || '/api'

// Tarih se├ğenekleri
export const DATE_PRESETS = [
  { id: 'all', label: 'T├╝m Zamanlar', days: -100 }, // Tarih filtresi yok
  { id: 'today', label: 'Bug├╝n', days: 0 },
  { id: 'yesterday', label: 'D├╝n', days: 1 },
  { id: 'last7', label: 'Son 7 G├╝n', days: 7 },
  { id: 'last30', label: 'Son 30 G├╝n', days: 30 },
  { id: 'thisMonth', label: 'Bu Ay', days: -1 }, // ├ûzel hesaplama
  { id: 'lastMonth', label: 'Ge├ğen Ay', days: -2 },
  { id: 'thisYear', label: 'Bu Y─▒l', days: -3 },
  { id: 'custom', label: '├ûzel Tarih', days: -99 },
] as const

export type DatePreset = typeof DATE_PRESETS[number]['id']

export interface Region {
  id: string
  code: string
  name: string
}

export interface Store {
  id: string
  code: string
  name: string
  storeType: 'MERKEZ' | 'FRANCHISE'
  regionId?: string
  regionName?: string
  city?: string
}

// Cross-Filter: Widget'tan t─▒klamayla gelen filtre
export interface CrossFilter {
  widgetId: string        // Hangi widget'tan geldi
  field: string           // Hangi alan (store_id, category, product_name)
  value: string | number  // De─şer
  label?: string          // G├Âr├╝nen isim
}

// Drill-Down: Detaya inme
export interface DrillDown {
  isOpen: boolean
  sourceWidgetId: string | null
  sourceMetricId: string | null
  field: string | null
  value: string | number | null
  label?: string
  data?: any[]           // Drill-down sonu├ğ verisi
  loading?: boolean
}

interface FilterState {
  // Veriler
  regions: Region[]
  stores: Store[]
  
  // Se├ğimler
  selectedRegionId: string | null  // null = t├╝m├╝
  selectedStoreIds: string[]       // bo┼ş = t├╝m├╝
  selectedStoreType: 'ALL' | 'MERKEZ' | 'FRANCHISE'
  
  // Tarih
  datePreset: DatePreset
  startDate: string  // YYYY-MM-DD
  endDate: string    // YYYY-MM-DD
  
  // Cross-Filter (Widget'tan filtre)
  crossFilters: CrossFilter[]
  
  // Drill-Down (Detaya inme)
  drillDown: DrillDown
  
  // Loading
  isLoading: boolean
  isLoaded: boolean
  
  // Actions
  loadFilters: (accessToken: string) => Promise<void>
  setRegion: (regionId: string | null) => void
  setStores: (storeIds: string[]) => void
  setStoreType: (type: 'ALL' | 'MERKEZ' | 'FRANCHISE') => void
  setDatePreset: (preset: DatePreset) => void
  setCustomDates: (start: string, end: string) => void
  selectAllStores: () => void
  selectRegionStores: (regionId: string) => void
  getFilteredStores: () => Store[]
  getDateRange: () => { start: string; end: string }
  resetFilters: () => void
  
  // Cross-Filter Actions
  addCrossFilter: (filter: CrossFilter) => void
  removeCrossFilter: (widgetId: string) => void
  clearCrossFilters: () => void
  
  // Drill-Down Actions
  openDrillDown: (widgetId: string, metricId: string, field: string, value: string | number, label?: string) => void
  closeDrillDown: () => void
  setDrillDownData: (data: any[]) => void
  setDrillDownLoading: (loading: boolean) => void
}

// Tarih yard─▒mc─▒ fonksiyonlar─▒
// NOT: toISOString() UTC kullan─▒r, T├╝rkiye UTC+3 oldu─şu i├ğin 1 g├╝n kayma olur!
// Bu y├╝zden yerel tarih format─▒ kullan─▒yoruz.
const formatDate = (date: Date) => {
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}
const today = () => new Date()
const daysAgo = (days: number) => {
  const d = new Date()
  d.setDate(d.getDate() - days)
  return d
}
const startOfMonth = (date: Date) => new Date(date.getFullYear(), date.getMonth(), 1)
const endOfMonth = (date: Date) => new Date(date.getFullYear(), date.getMonth() + 1, 0)
const startOfYear = (date: Date) => new Date(date.getFullYear(), 0, 1)

export const useFilterStore = create<FilterState>((set, get) => ({
  // Ba┼şlang─▒├ğ de─şerleri
  regions: [],
  stores: [],
  selectedRegionId: null,
  selectedStoreIds: [],
  selectedStoreType: 'ALL',
  datePreset: 'thisMonth',
  startDate: formatDate(startOfMonth(today())),
  endDate: formatDate(today()),
  isLoading: false,
  isLoaded: false,
  
  // Cross-Filter ba┼şlang─▒├ğ
  crossFilters: [],
  
  // Drill-Down ba┼şlang─▒├ğ
  drillDown: {
    isOpen: false,
    sourceWidgetId: null,
    sourceMetricId: null,
    field: null,
    value: null,
    label: undefined,
    data: undefined,
    loading: false
  },

  // Filtreleri API'den y├╝kle
  loadFilters: async (accessToken: string) => {
    if (!accessToken || get().isLoaded) return
    
    set({ isLoading: true })
    
    try {
      // B├Âlgeleri ├ğek
      const regionsRes = await fetch(`${API_BASE}/core/regions`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      })
      const regionsData = regionsRes.ok ? await regionsRes.json() : { data: [] }
      
      // Ma─şazalar─▒ ├ğek
      const storesRes = await fetch(`${API_BASE}/core/stores`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      })
      const storesData = storesRes.ok ? await storesRes.json() : { data: [] }
      
      const regions = (regionsData.data || []).map((r: any) => ({
        id: r.id,
        code: r.code,
        name: r.name
      }))
      
      const stores = (storesData.data || []).map((s: any) => ({
        id: s.id,
        code: s.code,
        name: s.name,
        storeType: s.store_type || 'MERKEZ',
        regionId: s.region_id,
        regionName: s.region_name,
        city: s.city
      }))
      
      set({ 
        regions, 
        stores, 
        isLoading: false, 
        isLoaded: true,
        // Varsay─▒lan: t├╝m ma─şazalar se├ğili
        selectedStoreIds: stores.map((s: Store) => s.id)
      })
    } catch (error) {
      console.error('[FILTER] Load error:', error)
      set({ isLoading: false, isLoaded: true })
    }
  },

  // B├Âlge se├ğ
  setRegion: (regionId: string | null) => {
    set({ selectedRegionId: regionId })
    // B├Âlge se├ğildi─şinde o b├Âlgenin ma─şazalar─▒n─▒ se├ğ
    if (regionId) {
      get().selectRegionStores(regionId)
    }
  },

  // Ma─şazalar─▒ se├ğ
  setStores: (storeIds: string[]) => {
    set({ selectedStoreIds: storeIds })
  },

  // Ma─şaza tipi se├ğ
  setStoreType: (type: 'ALL' | 'MERKEZ' | 'FRANCHISE') => {
    set({ selectedStoreType: type })
    // Tip de─şi┼şti─şinde filtrelenmi┼ş ma─şazalar─▒ g├╝ncelle
    const filtered = get().getFilteredStores()
    set({ selectedStoreIds: filtered.map(s => s.id) })
  },

  // Tarih preset se├ğ
  setDatePreset: (preset: DatePreset) => {
    let start: Date
    let end: Date = today()
    
    switch (preset) {
      case 'all':
        // T├╝m Zamanlar - tarih filtresi yok
        return set({
          datePreset: preset,
          startDate: '',
          endDate: ''
        })
      case 'today':
        start = today()
        break
      case 'yesterday':
        start = daysAgo(1)
        end = daysAgo(1)
        break
      case 'last7':
        start = daysAgo(7)
        break
      case 'last30':
        start = daysAgo(30)
        break
      case 'thisMonth':
        start = startOfMonth(today())
        break
      case 'lastMonth':
        const lastMonth = new Date()
        lastMonth.setMonth(lastMonth.getMonth() - 1)
        start = startOfMonth(lastMonth)
        end = endOfMonth(lastMonth)
        break
      case 'thisYear':
        start = startOfYear(today())
        break
      case 'custom':
        // Custom i├ğin mevcut tarihleri koru
        return set({ datePreset: preset })
      default:
        start = startOfMonth(today())
    }
    
    set({
      datePreset: preset,
      startDate: formatDate(start),
      endDate: formatDate(end)
    })
  },

  // ├ûzel tarih se├ğ
  setCustomDates: (start: string, end: string) => {
    set({
      datePreset: 'custom',
      startDate: start,
      endDate: end
    })
  },

  // T├╝m ma─şazalar─▒ se├ğ
  selectAllStores: () => {
    const { stores } = get()
    set({ 
      selectedRegionId: null,
      selectedStoreType: 'ALL',
      selectedStoreIds: stores.map(s => s.id)
    })
  },

  // B├Âlge ma─şazalar─▒n─▒ se├ğ
  selectRegionStores: (regionId: string) => {
    const { stores, selectedStoreType } = get()
    let filtered = stores.filter(s => s.regionId === regionId)
    
    if (selectedStoreType !== 'ALL') {
      filtered = filtered.filter(s => s.storeType === selectedStoreType)
    }
    
    set({ selectedStoreIds: filtered.map(s => s.id) })
  },

  // Filtrelenmi┼ş ma─şazalar─▒ getir
  getFilteredStores: () => {
    const { stores, selectedRegionId, selectedStoreType } = get()
    
    let filtered = stores
    
    if (selectedRegionId) {
      filtered = filtered.filter(s => s.regionId === selectedRegionId)
    }
    
    if (selectedStoreType !== 'ALL') {
      filtered = filtered.filter(s => s.storeType === selectedStoreType)
    }
    
    return filtered
  },

  // Tarih aral─▒─ş─▒n─▒ getir
  getDateRange: () => {
    const { startDate, endDate } = get()
    return { start: startDate, end: endDate }
  },

  // Filtreleri s─▒f─▒rla
  resetFilters: () => {
    const { stores } = get()
    set({
      selectedRegionId: null,
      selectedStoreIds: stores.map(s => s.id),
      selectedStoreType: 'ALL',
      datePreset: 'thisMonth',
      startDate: formatDate(startOfMonth(today())),
      endDate: formatDate(today()),
      crossFilters: []
    })
  },

  // ============================================
  // CROSS-FILTER ACTIONS
  // ============================================
  
  // Cross-filter ekle (ayn─▒ widget'tan gelen varsa g├╝ncelle)
  addCrossFilter: (filter: CrossFilter) => {
    const { crossFilters } = get()
    // Ayn─▒ widget'tan gelen filtreyi kald─▒r, yenisini ekle
    const updated = crossFilters.filter(f => f.widgetId !== filter.widgetId)
    set({ crossFilters: [...updated, filter] })
  },

  // Widget'a ait cross-filter'─▒ kald─▒r
  removeCrossFilter: (widgetId: string) => {
    const { crossFilters } = get()
    set({ crossFilters: crossFilters.filter(f => f.widgetId !== widgetId) })
  },

  // T├╝m cross-filter'lar─▒ temizle
  clearCrossFilters: () => {
    set({ crossFilters: [] })
  },

  // ============================================
  // DRILL-DOWN ACTIONS
  // ============================================
  
  // Drill-down a├ğ
  openDrillDown: (widgetId: string, metricId: string, field: string, value: string | number, label?: string) => {
    set({
      drillDown: {
        isOpen: true,
        sourceWidgetId: widgetId,
        sourceMetricId: metricId,
        field,
        value,
        label,
        data: undefined,
        loading: true
      }
    })
  },

  // Drill-down kapat
  closeDrillDown: () => {
    set({
      drillDown: {
        isOpen: false,
        sourceWidgetId: null,
        sourceMetricId: null,
        field: null,
        value: null,
        label: undefined,
        data: undefined,
        loading: false
      }
    })
  },

  // Drill-down verisi ayarla
  setDrillDownData: (data: any[]) => {
    set(state => ({
      drillDown: { ...state.drillDown, data, loading: false }
    }))
  },

  // Drill-down loading durumu
  setDrillDownLoading: (loading: boolean) => {
    set(state => ({
      drillDown: { ...state.drillDown, loading }
    }))
  }
}))




